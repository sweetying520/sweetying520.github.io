

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <!--è‡ªå®šä¹‰çœ‹æ¿å¨˜-->
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
  <script src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sweetying">
  <meta name="keywords" content="">
  
    <meta name="description" content="å‰è¨€ Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š ç¬¬ä¸€ç¯‡ï¼šâ€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ ç¬¬äºŒç¯‡ï¼š â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡  å…³äºHandlerï¼Œæƒ³å¿…å¤§å®¶éƒ½å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå®ƒæ˜¯Androidä¸­éå¸¸åŸºç¡€ï¼Œä½†åŒæ—¶ä¹Ÿæå…¶é‡è¦çš„æ¶ˆæ¯æœºåˆ¶ï¼Œè¯´å®ƒåŸºç¡€ï¼Œæ˜¯å› ä¸ºå®ƒä½¿ç”¨ç®€å•ï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ Androidæ—¶ï¼Œå°±ä¼šæ¥è§¦åˆ°Handlerï¼Œç”¨å®ƒæ¥è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡ã€‚è¯´å®ƒæå…¶é‡è¦ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨Andr">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ">
<meta property="og:url" content="https://sweetying520.github.io/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9AHandler%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="sweetying">
<meta property="og:description" content="å‰è¨€ Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š ç¬¬ä¸€ç¯‡ï¼šâ€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ ç¬¬äºŒç¯‡ï¼š â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡  å…³äºHandlerï¼Œæƒ³å¿…å¤§å®¶éƒ½å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå®ƒæ˜¯Androidä¸­éå¸¸åŸºç¡€ï¼Œä½†åŒæ—¶ä¹Ÿæå…¶é‡è¦çš„æ¶ˆæ¯æœºåˆ¶ï¼Œè¯´å®ƒåŸºç¡€ï¼Œæ˜¯å› ä¸ºå®ƒä½¿ç”¨ç®€å•ï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ Androidæ—¶ï¼Œå°±ä¼šæ¥è§¦åˆ°Handlerï¼Œç”¨å®ƒæ¥è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡ã€‚è¯´å®ƒæå…¶é‡è¦ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨Andr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88a4d99892f746b988d2f88a1e44a2f9~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72362e6cb08043fa8094f459fbd6291e~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2849c508f7a342e9b53f2b8384066c57~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c76ccdd09feb4aa2a41ba0789da36c38~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="article:published_time" content="2022-10-11T02:50:49.000Z">
<meta property="article:modified_time" content="2022-10-11T03:43:48.725Z">
<meta property="article:author" content="sweetying">
<meta property="article:tag" content="åŸåˆ›">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="ä¸€ç¯‡å°±å¤Ÿ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88a4d99892f746b988d2f88a1e44a2f9~tplv-k3u1fbpfcp-zoom-1.image">
  
  
  
  <title>ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ - sweetying</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/iconfont_juejin/iconfont.css">
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sweetying520.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"zN1E017kYhKuj6GqXHJSbGMb-gzGzoHsz","app_key":"JSwY8PjtA131Y78OHn7kKtio","server_url":"https://zn1e017k.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  <div>
	<div class='real_mask' style="
		background-color: rgba(0,0,0,0.3);
		width: 100%;
		height: 100%;
		position: fixed;
		z-index: -777;
	"></div>
	<div id="banner_video_insert">
	</div>
	<div id='vvd_banner_img'>
	</div>
</div>
<div id="banner"></div>

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sweetying</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html">
                <i class="iconfont icon-rss"></i>
                è™«æ´
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://101.43.39.125/HexoFiles/new/bg-trans.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        sweetying
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-11 10:50" pubdate>
          2022å¹´10æœˆ11æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          20k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          166 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

	<script type="text/javascript" src="/vvd_js/jquery.js"></script>

	<div class="banner" id='banner' >

		<div class="full-bg-img" >

			
				<script>
					var ua = navigator.userAgent;
					var ipad = ua.match(/(iPad).*OS\s([\d_]+)/),
						isIphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/),
						isAndroid = ua.match(/(Android)\s+([\d.]+)/),
						isMobile = isIphone || isAndroid;

					function set_video_attr(id){

						var height = document.body.clientHeight
						var width = document.body.clientWidth
						var video_item = document.getElementById(id);

						if (height / width < 0.56){
							video_item.setAttribute('width', '100%');
							video_item.setAttribute('height', 'auto');
						} else {
							video_item.setAttribute('height', '100%');
							video_item.setAttribute('width', 'auto');
						}
					}

					$.getJSON('/vvd_js/video_url.json', function(data){
						if (true){
							var video_list_length = data.length
							var seed = Math.random()
							index = Math.floor(seed * video_list_length)

							video_url = data[index][0]
							pre_show_image_url = data[index][1]

							banner_obj = document.getElementById("banner")
							banner_obj.style.cssText = "background: url('" + pre_show_image_url + "') no-repeat; background-size: cover;"

							vvd_banner_obj = document.getElementById("vvd_banner_img")

							vvd_banner_content = "<img id='banner_img_item' src='" + pre_show_image_url + "' style='height: 100%; position: fixed; z-index: -999'>"
							vvd_banner_obj.innerHTML = vvd_banner_content
							set_video_attr('banner_img_item')

							if (!isMobile) {
								video_html_res = "<video id='video_item' style='position: fixed; z-index: -888;'  muted='muted' src=" + video_url + " autoplay='autoplay' loop='loop'></video>"
								document.getElementById("banner_video_insert").innerHTML = video_html_res;
								set_video_attr('video_item')
							}
						}
					});

					if (!isMobile){
						window.onresize = function(){
							set_video_attr('video_item')
							}
						}
				</script>
			
			</div>
		</div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote>
<p>Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š</p>
<p>ç¬¬ä¸€ç¯‡ï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6924084444609544199#heading-5">â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ</a></p>
<p>ç¬¬äºŒç¯‡ï¼š <a target="_blank" rel="noopener" href="https://juejin.cn/post/6932608660354891790/">â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡</a></p>
</blockquote>
<p>å…³äºHandlerï¼Œæƒ³å¿…å¤§å®¶éƒ½å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå®ƒæ˜¯Androidä¸­éå¸¸åŸºç¡€ï¼Œä½†åŒæ—¶ä¹Ÿæå…¶é‡è¦çš„æ¶ˆæ¯æœºåˆ¶ï¼Œè¯´å®ƒåŸºç¡€ï¼Œæ˜¯å› ä¸ºå®ƒä½¿ç”¨ç®€å•ï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ Androidæ—¶ï¼Œå°±ä¼šæ¥è§¦åˆ°Handlerï¼Œç”¨å®ƒæ¥è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡ã€‚è¯´å®ƒæå…¶é‡è¦ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨Androidç³»ç»Ÿä¸­æ‰®æ¼”äº†ä¸€ä¸ªæå…¶æ ¸å¿ƒçš„è§’è‰²ï¼Œå¯ä»¥è¯´åªè¦æœ‰å¼‚æ­¥é€šä¿¡çš„åœ°æ–¹å°±ä¸€å®šä¼šæœ‰Handlerï¼Œæ­£æ˜¯å› ä¸ºå®ƒçš„å­˜åœ¨ï¼Œä½¿å¾—æˆ‘ä»¬Androidç³»ç»Ÿä¸­çš„å¾ˆå¤šç»„ä»¶èƒ½å¤Ÿæ­£å¸¸çš„è¿è¡Œ</p>
<p><strong>æ³¨æ„ï¼šæœ¬æ–‡æ‰€å±•ç¤ºçš„ç³»ç»Ÿæºç éƒ½æ˜¯åŸºäºAndroid-29 ï¼Œå¹¶æå–æ ¸å¿ƒéƒ¨åˆ†è¿›è¡Œåˆ†æ</strong></p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¸‹é¢æˆ‘åœ¨è¿™é‡ŒæŠ›å‡ºä¸€äº›é—®é¢˜ï¼Œå¦‚æœä½ éƒ½çŸ¥é“ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ å¯¹Handleræœºåˆ¶æŒæ¡çš„å¾ˆé€å½»ï¼Œå¦‚æœä½ å¯¹ä¸‹é¢è¿™äº›é—®é¢˜æœ‰ä¸€äº›ç–‘æƒ‘ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥æ¥ç€å¾€ä¸‹çœ‹ï¼Œæˆ‘ä¼šç”±æµ…å…¥æ·±çš„ç»™ä½ è®²è§£Handleræœºåˆ¶ï¼Œçœ‹å®Œä¹‹åï¼Œè¿™äº›é—®é¢˜ä½ å°±éƒ½ä¼šéå¸¸çš„æ˜äº†ï¼ŒåŒæ—¶åœ¨æœ€åæˆ‘ä¹Ÿä¼šå¯¹è¿™äº›é—®é¢˜ç»™å‡ºè‡ªå·±çš„å›ç­”</p>
<ol>
<li>Handleræœ‰å“ªäº›ä½œç”¨?</li>
<li>ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»ºLooper?</li>
<li>å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œéœ€è¦åšä»€ä¹ˆå‡†å¤‡?</li>
<li>ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandler?</li>
<li>ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªLooper?å¦‚ä½•ä¿è¯?</li>
<li>ä¸ºä»€ä¹ˆLopperæ­»å¾ªç¯ï¼Œå´ä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»?</li>
<li>Handlerå†…å­˜æ³„éœ²åŸå› ? å¦‚ä½•è§£å†³ï¼Ÿ</li>
<li>çº¿ç¨‹ç»´æŠ¤çš„Looperï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ?æœ‰ä»€ä¹ˆç”¨?</li>
<li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªHandlerå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å‘æ¶ˆæ¯çš„Handlerå­˜åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆHandleræ˜¯å¦‚ä½•ä¿è¯MessageQueueå¹¶å‘è®¿é—®å®‰å…¨çš„å‘¢ï¼Ÿ</li>
<li>Handleræ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ</li>
<li>æˆ‘ä»¬åœ¨ä½¿ç”¨Messageçš„æ—¶å€™,åº”è¯¥å¦‚ä½•å»åˆ›å»ºå®ƒï¼Ÿ</li>
<li>Handleré‡Œé¢è—ç€çš„CallBackèƒ½åšä»€ä¹ˆï¼Ÿ</li>
<li>Handleré˜»å¡å”¤é†’æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ</li>
<li>ä»€ä¹ˆæ˜¯Handlerçš„åŒæ­¥å±éšœï¼Ÿ</li>
<li>èƒ½ä¸èƒ½è®©ä¸€ä¸ªMessageè¢«åŠ æ€¥å¤„ç†ï¼Ÿ</li>
</ol>
<h2 id="ä»€ä¹ˆæ˜¯Handler"><a href="#ä»€ä¹ˆæ˜¯Handler" class="headerlink" title="ä»€ä¹ˆæ˜¯Handler?"></a>ä»€ä¹ˆæ˜¯Handler?</h2><p>æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„Handlerï¼Œä»–å…¶å®æ˜¯Handleræœºåˆ¶ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œåªä¸è¿‡æˆ‘ä»¬å¯¹Handleræ¥è§¦æ¯”è¾ƒå¤šï¼Œå› æ­¤ç”¨Handleræ¥ä»£ç§°</p>
<p><strong>Handleræœºåˆ¶æ˜¯Androidä¸­åŸºäºå•çº¿æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼çš„ä¸€å¥—çº¿ç¨‹æ¶ˆæ¯æœºåˆ¶ã€‚</strong></p>
<h2 id="HandleråŸºæœ¬ç”¨æ³•"><a href="#HandleråŸºæœ¬ç”¨æ³•" class="headerlink" title="HandleråŸºæœ¬ç”¨æ³•"></a>HandleråŸºæœ¬ç”¨æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åœ¨ä¸»çº¿ç¨‹åˆ›å»ºHandlerå®ä¾‹</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-comment">//å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯</span><br>        &#125;<br>    &#125;;<br><br><span class="hljs-comment">//åœ¨é€‚å½“çš„æ—¶æœºä½¿ç”¨Handlerå®ä¾‹å‘é€æ¶ˆæ¯</span><br>mHandler.sendMessage(message);<br>mHandler.post(runnable);<span class="hljs-comment">//Runnableä¼šè¢«å°è£…è¿›ä¸€ä¸ªMessageï¼Œæ‰€ä»¥å®ƒæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªMessage</span><br></code></pre></td></tr></table></figure>

<p>çœ‹ä¸Šé¢è¿™æ®µä»£ç ï¼Œåˆ›å»ºäº†ä¸€ä¸ªHandlerå®ä¾‹å¹¶é‡å†™äº† <code>handleMessage</code> æ–¹æ³• ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨å®ƒçš„ <code>send</code> æˆ–è€… <code>post</code> ç³»åˆ—æ–¹æ³•å°±å¯ä»¥äº†ï¼Œä½¿ç”¨å°±æ˜¯è¿™ä¹ˆç®€å•</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡çš„å‘¢? ä¸‹é¢æˆ‘ä»¬å°±éœ€è¦å¯¹æºç è¿›è¡Œåˆ†æ</p>
<h2 id="Handleræœºåˆ¶æºç åˆ†æ"><a href="#Handleræœºåˆ¶æºç åˆ†æ" class="headerlink" title="Handleræœºåˆ¶æºç åˆ†æ"></a>Handleræœºåˆ¶æºç åˆ†æ</h2><p>åœ¨åˆ†ææºç ä¹‹å‰,æˆ‘å…ˆè®²ä¸‹Handleræœºåˆ¶æ¶‰åŠçš„å‡ å¤§è§’è‰²: <strong>Handler,Looper,MessageQueue,Message</strong></p>
<p>å…ˆæå‰ä»‹ç»ä¸‹è¿™å‡ ä¸ªè§’è‰²çš„ä½œç”¨,ä¾¿äºåç»­åˆ†ææºç çš„ä¸€ä¸ªç†è§£</p>
<p><strong>Handler</strong>: å‘é€æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯</p>
<p><strong>Looper</strong>: ä»MessageQueueä¸­è·å–Messageï¼Œç„¶åäº¤ç»™Handlerå¤„ç†</p>
<p><strong>MessageQueue</strong>: æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜æ”¾Handlerå‘é€è¿‡æ¥çš„æ¶ˆæ¯</p>
<p><strong>Message</strong>: æ¶ˆæ¯çš„è½½ä½“</p>
<p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹è¿›è¡Œæºç åˆ†æï¼Œåœ¨æˆ‘ä»¬ä¸€å¼€å§‹ä½¿ç”¨çš„æ—¶å€™ï¼Œåˆ›å»ºäº†ä¸€ä¸ªHandlerå®ä¾‹ï¼Œé‚£æˆ‘ä»¬çœ‹ä¸‹å®ƒå®ä¾‹åŒ–çš„è¿™ä¸ªæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-built_in">this</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®ƒå…¶å®æ˜¯è°ƒç”¨äº†å®ƒçš„ä¸€ä¸ªé‡è½½çš„æ–¹æ³•,æ¥ç€çœ‹å®ƒçš„é‡è½½æ–¹æ³•</p>
<p><strong>æ³¨æ„:</strong> </p>
<ol>
<li>Handlerçš„æ„é€ æ–¹æ³•ä¸­è¿˜å¯ä»¥ä¼ å…¥Looperï¼Œé€šè¿‡ä¼ å…¥Looperçš„æ„é€ æ–¹æ³•å¯ä»¥å®ç°ä¸€äº›ç‰¹æ®Šçš„åŠŸèƒ½</li>
<li>Handlerçš„æ„é€ æ–¹æ³•ä¸­è¿˜å¯ä»¥ä¼ å…¥Callbackï¼Œè¿™ç§æ–¹å¼åˆ›å»ºä¸€ä¸ªHandlerçš„å®ä¾‹ï¼Œå®ƒå¹¶ä¸éœ€è¦æ´¾ç”Ÿå‡ºä¸€ä¸ªå­ç±»ï¼Œåé¢æˆ‘ä¹Ÿä¼šä»‹ç»åˆ°</li>
<li>æœ‰äº›æ„é€ æ–¹æ³•ä½¿ç”¨äº†<code>@UnsupportedAppUsage</code>æ³¨è§£ï¼Œè¡¨ç¤ºä¸æ”¯æŒå¤–éƒ¨åº”ç”¨è°ƒç”¨</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Callback callback, <span class="hljs-type">boolean</span> async)</span> &#123;<br>  	<span class="hljs-comment">//...</span><br>    <span class="hljs-comment">//è·å–å½“å‰çº¿ç¨‹çš„Lopper</span><br>    mLooper = Looper.myLooper();<br>    <span class="hljs-comment">//å¦‚æœå½“å‰Looperä¸ºç©º,åˆ™æŠ›å‡ºå¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (mLooper == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>            <span class="hljs-string">&quot;Can&#x27;t create handler inside thread &quot;</span> + Thread.currentThread()<br>                    + <span class="hljs-string">&quot; that has not called Looper.prepare()&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//å°†å½“å‰Lopperä¸­çš„MessageQueueèµ‹å€¼ç»™Handlerä¸­çš„MessageQueue</span><br>    mQueue = mLooper.mQueue;<br>    <span class="hljs-comment">//...</span><br> &#125;<br><br><span class="hljs-comment">//---------------------ä»¥ä¸‹ä¸ºé¢å¤–æ‰©å±•å†…å®¹--------------------------</span><br><span class="hljs-comment">//ä¼ å…¥Looperçš„æ„é€ æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Looper looper)</span> &#123;<br>    <span class="hljs-built_in">this</span>(looper, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-comment">//ä¼ å…¥Callbackçš„æ„é€ æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Callback callback)</span> &#123;<br>    <span class="hljs-built_in">this</span>(callback, <span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-comment">//ä½¿ç”¨äº†@UnsupportedAppUsageæ³¨è§£çš„æ„é€ æ–¹æ³•</span><br><span class="hljs-meta">@UnsupportedAppUsage</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-type">boolean</span> async)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-literal">null</span>, async);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š <strong>æˆ‘ä»¬åœ¨åˆ›å»ºHandlerå®ä¾‹çš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆåˆ›å»ºä¸€ä¸ªLopperï¼Œå¹¶å¼€å¯å¾ªç¯è¯»å–æ¶ˆæ¯</strong>ï¼Œé‚£ä¹ˆå¤§å®¶è‚¯å®šæœ‰ä¸ªç–‘é—®ï¼Ÿ ä½ ä¸Šé¢çš„ä½¿ç”¨å°±æ²¡æœ‰åˆ›å»ºLopperï¼Œé‚£æ˜¯å› ä¸ºæˆ‘ä»¬çš„ä¸»çº¿ç¨‹å·²ç»ç»™æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªLopper</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾ä¸‹ä¸»çº¿ç¨‹çš„è¿™ä¸ªLopperæ˜¯åœ¨å“ªé‡Œåˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ‰¾åˆ°ActivityThreadçš„main()æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>  <span class="hljs-comment">//...</span><br> 	<span class="hljs-comment">//åˆ›å»ºLopper</span><br>  Looper.prepareMainLooper();<br>  <br>  <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br>  thread.attach(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) &#123;<br>    sMainThreadHandler = thread.getHandler();<br>  &#125;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-comment">//å¼€å¯å¾ªç¯è¯»å–æ¶ˆæ¯</span><br>  Looper.loop();<br>	<span class="hljs-comment">//Looperå¦‚æœå› å¼‚å¸¸åŸå› åœæ­¢å¾ªç¯åˆ™æŠ›å¼‚å¸¸</span><br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼šé€šå¸¸æˆ‘ä»¬è®¤ä¸º ActivityThread å°±æ˜¯ä¸»çº¿ç¨‹ã€‚äº‹å®ä¸Šå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯ä¸»çº¿ç¨‹æ“ä½œçš„ç®¡ç†è€…ï¼Œæ‰€ä»¥ä»¬æŠŠ ActivityThread è®¤ä¸ºå°±æ˜¯ä¸»çº¿ç¨‹æ— å¯åšéï¼Œå¦å¤–ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥è¯´æˆ UI çº¿ç¨‹ã€‚</strong></p>
<p>æˆ‘ä»¬åœ¨ ActivityThreadé‡Œçš„<code>main</code>æ–¹æ³•é‡Œè°ƒç”¨äº†Looper.prepareMainLooper() æ–¹æ³•åˆ›å»ºäº†ä¸»çº¿ç¨‹çš„Looper ï¼Œå¹¶ä¸”è°ƒç”¨äº†<code>loop</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ Handler</p>
<p>ç»§ç»­åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“main()æ–¹æ³•æ˜¯Javaç¨‹åºçš„å…¥å£ï¼ŒåŒæ—¶ä¹Ÿæ˜¯Androidåº”ç”¨ç¨‹åºçš„å…¥å£ï¼Œè€Œåœ¨Javaä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œå®Œmain()æ–¹æ³•ï¼Œé©¬ä¸Šå°±é€€å‡ºäº†ï¼Œè€Œåœ¨Androidä¸­ï¼Œä¸ºå•¥æ²¡æœ‰é€€å‡ºå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬åšä¸ªå‡è®¾ï¼Œå¦‚æœåœ¨Androidä¸­ä¹Ÿé€€å‡ºäº†ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯Androidå°±æ²¡å¾—ç©äº†ï¼Œæ‰€ä»¥Googleè‚¯å®šæ˜¯ä¸èƒ½è®©ä»–é€€å‡ºçš„ï¼Œä¹‹æ‰€ä»¥åœ¨Androidä¸­æ²¡æœ‰é€€å‡ºï¼Œæ­£æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºå¹¶å¼€å¯äº†Looperæ­»å¾ªç¯ï¼Œä»–ä¼šå¾ªç¯æ‰§è¡Œå„ç§äº‹ç‰©ã€‚Looperæ­»å¾ªç¯è¯´æ˜çº¿ç¨‹æ²¡æœ‰æ­»äº¡ï¼Œå¦‚æœLooperåœæ­¢å¾ªç¯ï¼Œçº¿ç¨‹åˆ™ç»“æŸé€€å‡ºäº†</p>
<p>é‚£ä¹ˆå¤§å®¶æ˜¯ä¸æ˜¯åˆä¼šæœ‰ä¸ªç–‘é—®ï¼Ÿæ—¢ç„¶æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œé‚£ä¸ºå•¥ä¸ä¼šé€ æˆANRï¼Ÿ</p>
<p>å…¶å®Lopperæ­»å¾ªç¯å’Œç¨‹åºANRæ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè¿™é‡Œæ„Ÿè§‰å°±æ˜¯åœ¨è¿›è¡Œä¸€ä¸ªæ¦‚å¿µçš„æ··æ·†ï¼Œè¿™é‡Œæˆ‘è§£é‡Šä¸€ä¸‹è¿™ä¸¤ä¸ªæ¦‚å¿µ</p>
<p>ANR: å…¨ç§°Applicationn Not Respondingï¼Œä¸­æ–‡æ„æ€æ˜¯åº”ç”¨æ— å“åº”ï¼Œå½“æˆ‘å‘é€ä¸€ä¸ªæ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ï¼Œç»è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šæŠ›å‡ºANRå¼‚å¸¸</p>
<p>Lopperæ­»å¾ªç¯: å¾ªç¯æ‰§è¡Œå„ç§äº‹åŠ¡ï¼Œå½“Looperå¤„ç†å®Œæ‰€æœ‰æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå½“æœ‰æ–°çš„Messageè¿›æ¥çš„æ—¶å€™ä¼šæ‰“ç ´é˜»å¡ç»§ç»­æ‰§è¡Œ</p>
<p>åˆ°äº†è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶å¯¹äºåˆ›å»ºHandlerå·²ç»å¾ˆæ˜äº†äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®é™…åº”ç”¨ä¸€ä¸‹ï¼Œåœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œç›´æ¥ä¸Šä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">public</span> Handler mHandler;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            Looper.prepare();<br>            mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() &#123;<br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>										<span class="hljs-comment">//å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯</span><br>                &#125;<br>            &#125;;<br>            Looper.loop();<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¥½ï¼Œåˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥å¯¹<strong>åˆ›å»ºHandlerå®ä¾‹çš„æ—¶å€™,ä¸€å®šè¦å…ˆåˆ›å»ºä¸€ä¸ªLopperï¼Œå¹¶å¼€å¯å¾ªç¯è¯»å–æ¶ˆæ¯</strong>ï¼Œæœ‰äº†æ·±åˆ»çš„ç†è§£ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†ææºç </p>
<p>ä¸Šé¢è¯´äº†åˆ›å»ºHandlerå®ä¾‹ä¹‹å‰è¦å…ˆåˆ›å»ºLooperå¹¶å¼€å¯å¾ªç¯ï¼Œé‚£æˆ‘ä»¬åˆ†æä¸‹åˆ›å»ºLopperå¹¶å¼€å¯å¾ªç¯è¿™ä¸ªè¿‡ç¨‹ï¼Œå…ˆçœ‹ä¸‹ActivityThreadé‡Œçš„<code>main</code>æ–¹æ³•é‡Œè°ƒç”¨çš„Looper.prepareMainLooper()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareMainLooper</span><span class="hljs-params">()</span> &#123;<br>  	<span class="hljs-comment">//åˆ›å»ºLooper,å‚æ•°falseè¡¨ç¤ºè¯¥Looperä¸èƒ½é€€å‡º</span><br>    prepare(<span class="hljs-literal">false</span>);<br>  	<span class="hljs-comment">//æ·»åŠ åŒæ­¥é”</span><br>    <span class="hljs-keyword">synchronized</span> (Looper.class) &#123;<br>      	<span class="hljs-comment">//å¦‚æœå½“å‰sMainLooperå·²ç»å­˜åœ¨,åˆ™æŠ›å¼‚å¸¸</span><br>        <span class="hljs-keyword">if</span> (sMainLooper != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;The main Looper has already been prepared.&quot;</span>);<br>        &#125;<br>      	<span class="hljs-comment">//å°†å½“å‰çº¿ç¨‹çš„Looperå®ä¾‹èµ‹å€¼ç»™sMainLooper</span><br>        sMainLooper = myLooper();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®é™…ä¸Šä¸»è¦æ˜¯è°ƒç”¨äº†å¦å¤–ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸‹prepare(false)å’ŒmyLooper()æ–¹æ³•çš„å†…éƒ¨å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span> &#123;<br>  	 <span class="hljs-comment">//é€šè¿‡sThreadLocalè·å–å½“å‰Looperå®ä¾‹,å¦‚æœå½“å‰Lopperå®ä¾‹ä¸ä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸</span><br>     <span class="hljs-keyword">if</span> (sThreadLocal.get() != <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Only one Looper may be created per thread&quot;</span>);<br>     &#125;<br>  	 <span class="hljs-comment">//å°†newå‡ºæ¥çš„Looperå®ä¾‹è®¾ç½®ç»™sThreadLocal</span><br>     sThreadLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Looper</span>(quitAllowed));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-meta">@Nullable</span> Looper <span class="hljs-title function_">myLooper</span><span class="hljs-params">()</span> &#123;<br>  	 <span class="hljs-comment">//é€šè¿‡sThreadLocalè·å–Looperå®ä¾‹å¯¹è±¡</span><br>     <span class="hljs-keyword">return</span> sThreadLocal.get();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>prepare</code>æ–¹æ³•: newä¸€ä¸ªLooperè®¾ç½®ç»™sThreadLocal. <code>myLooper</code>æ–¹æ³•: é€šè¿‡sThreadLocalè·å–Looper. ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•ï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ä¼šå¯¹è¿™ä¸ªsThreadLocalå¾ˆå¥½å¥‡ï¼Œè¿™ä¸ªä¸œè¥¿æœ‰å•¥ä½œç”¨ï¼Œæˆ‘ä»¬æ ¹æ®ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¯ä»¥æ¨æ–­å‡º: sThreadLocalæ˜¯ç”¨æ¥å­˜æ”¾Looperçš„</p>
<h3 id="ThreadLocalä»‹ç»"><a href="#ThreadLocalä»‹ç»" class="headerlink" title="ThreadLocalä»‹ç»"></a>ThreadLocalä»‹ç»</h3><p><strong>ThreadLocalæ˜¯Javaä¸­ä¸€ä¸ªç”¨äºçº¿ç¨‹å†…éƒ¨å­˜å‚¨æ•°æ®çš„å·¥å…·ç±»</strong></p>
<p>çœ‹ä¸‹é¢è¿™ä¸€æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>     ThreadLocal&lt;Boolean&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br>     threadLocal.set(<span class="hljs-literal">true</span>);<br>     <span class="hljs-type">Boolean</span> <span class="hljs-variable">aBoolean</span> <span class="hljs-operator">=</span> threadLocal.get();<br>     System.out.println(<span class="hljs-string">&quot;Current Thread &quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot;: &quot;</span> + aBoolean);<br>		 <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å‘½åä¸ºa</span><br>     <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-string">&quot;a&quot;</span>)&#123;<br>         <span class="hljs-meta">@Override</span><br>          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>              threadLocal.set(<span class="hljs-literal">false</span>);<br>              <span class="hljs-type">Boolean</span> <span class="hljs-variable">bBoolean</span> <span class="hljs-operator">=</span> threadLocal.get();<br>              System.out.println(<span class="hljs-string">&quot;Current Thread &quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot;: &quot;</span> + bBoolean);<br>          &#125;<br>     &#125;.start();<br>		 <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å‘½åä¸ºb</span><br>     <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-string">&quot;b&quot;</span>)&#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123; ;<br>             <span class="hljs-type">Boolean</span> <span class="hljs-variable">cBoolean</span> <span class="hljs-operator">=</span> threadLocal.get();<br>             System.out.println(<span class="hljs-string">&quot;Current Thread &quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot;: &quot;</span> + cBoolean);<br>         &#125;<br>     &#125;.start();<br> &#125;<br><br><span class="hljs-comment">//æ‰“å°ç»“æœ:</span><br>Current Thread main: <span class="hljs-literal">true</span><br>Current Thread a: <span class="hljs-literal">false</span><br>Current Thread b: <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç : </p>
<ol>
<li>åœ¨ä¸»çº¿ç¨‹åˆ›å»ºäº†ä¸€ä¸ªthreadLocalå˜é‡ï¼Œå¹¶è°ƒç”¨<code>set</code>æ–¹æ³•è®¾ç½®ä¸ºtrueï¼Œç„¶åè·å–è¯¥å€¼å¹¶æ‰“å°</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶è°ƒç”¨<code>set</code>æ–¹æ³•è®¾ç½®å€¼ä¸ºfalseï¼Œè·å–è·å–è¯¥å€¼å¹¶æ‰“å°</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè·å–è¯¥å€¼å¹¶æ‰“å°</li>
</ol>
<p>ä»ä¸Šé¢çš„æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è®¿é—®åŒä¸€ä¸ªthreadLocalå¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬é€šè¿‡ThreadLocalè·å–çš„å€¼å´æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™å°±æ˜¯ThreadLocalçš„å¥‡å¦™ä¹‹å¤„ï¼Œè¿™é‡Œæˆ‘åˆæƒ³é—®ä¸€å¥,ä¸ºä»€ä¹ˆ? å‡¡äº‹å¤šé—®å‡ ä¸ªä¸ºä»€ä¹ˆï¼ŒçŸ¥è¯†åŸç†å°±å­¦åˆ°æ‰‹äº†ï¼Œå“ˆå“ˆğŸ˜„ï¼Œæˆ‘ä»¬ç‚¹è¿›å»ThreadLocalçš„<code>set</code>æ–¹æ³•çœ‹ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>  	<span class="hljs-comment">//è·å–å½“å‰çº¿ç¨‹</span><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>  	<span class="hljs-comment">//è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span><br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)<br>      	<span class="hljs-comment">//å¦‚æœmapä¸ä¸ºç©º,åˆ™å°†å½“å‰çš„ThreadLocalå˜é‡ä½œä¸ºkey,ä¼ è¿›æ¥çš„æ³›å‹ä½œä¸ºvalueè¿›è¡Œå­˜å‚¨</span><br>        map.set(<span class="hljs-built_in">this</span>, value);<br>    <span class="hljs-keyword">else</span><br>      	<span class="hljs-comment">//å¦‚æœmapä¸ºç©º,åˆ™ä¼šåˆ›å»ºmap,å°†å½“å‰çš„ThreadLocalå˜é‡ä½œä¸ºkey,ä¼ è¿›æ¥çš„æ³›å‹ä½œä¸ºvalueè¿›è¡Œå­˜å‚¨</span><br>        createMap(t, value);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢ä»£ç æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œåœ¨æŠŠThreadLocalå˜é‡ä½œä¸ºkeyï¼Œä¼ è¿›æ¥çš„æ³›å‹ä½œä¸ºvalueè¿›è¡Œå­˜å‚¨</p>
<p><strong>ThreadLocalMap</strong>å®ƒæ˜¯ThreadLocalé‡Œé¢çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå®ƒç±»ä¼¼äºä¸€ä¸ªæ”¹ç‰ˆçš„HashMapï¼Œå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨æ•°ç»„å’ŒHashç®—æ³•æ¥å­˜å‚¨æ•°æ®ï¼Œä½¿å¾—å­˜å‚¨å’Œè¯»å–çš„é€Ÿåº¦éå¸¸å¿«ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨HashMapçš„æ€æƒ³å»ç†è§£ThreadLocalMapå°±å¥½äº†ï¼Œå¦‚æœå¯¹ThreadLocalMapå·¥ä½œåŸç†æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904141890781192">ä¼ é€é—¨</a></p>
<p>åœ¨çœ‹ä¸‹<code>get</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> setInitialValue();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œå‰é¢è®²åˆ°ThreadLocalMapå…¶å®éå¸¸åƒä¸€ä¸ªHashMapï¼Œä»–çš„getæ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä½¿ç”¨ThreadLocalä½œä¸ºkeyè·å–åˆ°å¯¹åº”çš„Entryï¼Œå†æŠŠvalueè¿”å›å³å¯ï¼Œå¦‚æœmapå°šæœªåˆå§‹åŒ–åˆ™ä¼šæ‰§è¡Œåˆå§‹åŒ–æ“ä½œ</p>
<p>å› æ­¤æˆ‘ä»¬æ˜¯å¦å¯ä»¥å¾—åˆ°ç»“è®º:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88a4d99892f746b988d2f88a1e44a2f9~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload alt="image-20210201082013061"></p>
<p>ThreadLocalä¼šä»å„è‡ªçš„çº¿ç¨‹ï¼Œå–å‡ºè‡ªå·±ç»´æŠ¤çš„ThreadLocalMapï¼Œå…¶keyä¸ºThreadLocalï¼Œvalueä¸ºThreadLocalå¯¹åº”çš„æ³›å‹å¯¹è±¡ï¼Œè¿™æ ·æ¯ä¸ªThreadLocalå°±å¯ä»¥æŠŠè‡ªå·±ä½œä¸ºkeyæŠŠä¸åŒçš„valueå­˜å‚¨åœ¨ä¸åŒçš„ThreadLocalMapï¼Œå½“è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŒä¸ªThreadLocalå°±å¯ä»¥ä»ä¸åŒçº¿ç¨‹çš„ThreadLocalMapä¸­å¾—åˆ°ä¸åŒçš„æ•°æ®ã€‚å› æ­¤å½“æˆ‘ä»¬ä»¥çº¿ç¨‹ä½œä¸ºä½œç”¨åŸŸï¼Œå¹¶ä¸”ä¸åŒçº¿ç¨‹éœ€è¦å…·æœ‰ä¸åŒæ•°æ®å‰¯æœ¬çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ThreadLocalã€‚è€ŒLooperæ­£å¥½é€‚ç”¨äºè¿™ç§åœºæ™¯</p>
<h3 id="Looperä»‹ç»"><a href="#Looperä»‹ç»" class="headerlink" title="Looperä»‹ç»"></a>Looperä»‹ç»</h3><p>ä¸Šé¢æˆ‘ä»¬åˆ†æåˆ°Looperä½¿ç”¨ThreadLocalæ¥ä¿è¯æ¯ä¸ªçº¿ç¨‹æœ‰ä¸”åªæœ‰ä¸€ä¸ªç›¸åŒçš„å‰¯æœ¬ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®º: <strong>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªLooper</strong>ï¼Œè¿™ä¸ªç»“è®ºéå¸¸çš„é‡è¦ï¼ŒHandleræœºåˆ¶ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œå°±æ˜¯å› ä¸ºä½¿ç”¨äº†ä¸åŒçº¿ç¨‹çš„Looperå¤„ç†æ¶ˆæ¯ï¼Œä¸¾ä¸ªä¾‹å­: æˆ‘åœ¨çº¿ç¨‹Aåˆ›å»ºäº†å‡ ä¸ªHanlderå®ä¾‹å¤„ç†æ¶ˆæ¯ï¼Œé‚£æˆ‘é¦–å…ˆå°±è¦åˆ›å»ºAçº¿ç¨‹çš„Looperå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œé‚£ä¹ˆæˆ‘ä¸ç®¡ä½ è¿™äº›Hanlderçš„å®ä¾‹ä»é‚£ä¸ªçº¿ç¨‹å‘é€æ¶ˆæ¯è¿‡æ¥ï¼Œæœ€ç»ˆéƒ½ä¼šå›åˆ°æˆ‘Açº¿ç¨‹çš„MessageQueueä¸­ï¼Œç„¶åé€šè¿‡Açº¿ç¨‹Looperä¸æ–­è¯»å–æ¶ˆæ¯ï¼Œåœ¨äº¤ç»™å½“å‰Açº¿ç¨‹çš„Handleræ¥å¤„ç†</p>
<p>Looperå¯ä»¥è¯´æ˜¯Handleræœºåˆ¶ä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ ¸å¿ƒã€‚Looperç›¸å½“äºçº¿ç¨‹æ¶ˆæ¯æœºåˆ¶çš„å¼•æ“ï¼Œé©±åŠ¨æ•´ä¸ªæ¶ˆæ¯æœºåˆ¶è¿è¡Œã€‚Looperè´Ÿè´£ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œç„¶åäº¤ç»™å¯¹åº”çš„Handlerå»å¤„ç†ã€‚å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™MessageQueueçš„nextæ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹ï¼Œç­‰å¾…æ–°çš„æ¶ˆæ¯çš„åˆ°æ¥ã€‚æ¯ä¸ªçº¿ç¨‹æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªâ€œå¼•æ“â€ï¼Œä¹Ÿå°±æ˜¯Looperï¼Œå¦‚æœæ²¡æœ‰Looperï¼Œé‚£ä¹ˆæ¶ˆæ¯æœºåˆ¶å°±è¿è¡Œä¸èµ·æ¥ï¼Œè€Œå¦‚æœæœ‰å¤šä¸ªLooperï¼Œåˆ™ä¼šè¿èƒŒå•çº¿æ“ä½œçš„æ¦‚å¿µï¼Œé€ æˆå¹¶å‘æ“ä½œã€‚</p>
<h4 id="Looperåˆ›å»º"><a href="#Looperåˆ›å»º" class="headerlink" title="Looperåˆ›å»º"></a>Looperåˆ›å»º</h4><p>åœ¨ä¸Šé¢åˆ›å»ºLooperçš„æ—¶å€™æˆ‘ä»¬åˆ†æåˆ°:</p>
<ol>
<li><p>ä¸»çº¿ç¨‹ActivityThreadåˆ›å»ºLooperï¼Œä½¿ç”¨çš„æ˜¯<code>prepareMainLooper</code>æ–¹æ³•ï¼Œå®ƒæ˜¯ä¸ºä¸»çº¿ç¨‹é‡èº«å®šåšçš„ï¼Œç”±äºä¸»çº¿ç¨‹çš„Looperæ¯”è¾ƒç‰¹æ®Šï¼Œæ‰€ä»¥Looperæä¾›äº†ä¸€ä¸ª<code>getMainLooper</code>æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è·å–åˆ°ä¸»çº¿ç¨‹çš„Looperï¼Œä¸”ä¸»çº¿ç¨‹çš„Looperä¸èƒ½é€€å‡º</p>
</li>
<li><p>æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„Looperï¼Œä½¿ç”¨çš„æ˜¯<code>prepare</code>æ–¹æ³•ï¼Œå®è´¨ä¸Šå®ƒä»¬æœ€ç»ˆéƒ½ä¼šè°ƒåˆ°<code>prepare(boolean quitAllowed)</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œå¤–éƒ¨ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼ŒåŒºåˆ«å°±æ˜¯ä¸»çº¿ç¨‹åˆ›å»ºçš„Looperä¸èƒ½é€€å‡ºï¼Œè€Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å¯ä»¥é€€å‡º</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ä¸»çº¿ç¨‹</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareMainLooper</span><span class="hljs-params">()</span> &#123;<br>    prepare(<span class="hljs-literal">false</span>);<br>  	<span class="hljs-comment">//...</span><br>&#125;<br><br><span class="hljs-comment">//è·å–ä¸»çº¿ç¨‹Looper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Looper <span class="hljs-title function_">getMainLooper</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">synchronized</span> (Looper.class) &#123;<br>     <span class="hljs-keyword">return</span> sMainLooper;<br>     &#125;<br> &#125;<br><br><span class="hljs-comment">//æˆ‘ä»¬è‡ªå·±åˆ›å»ºLooper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span> &#123;<br>    prepare(<span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-comment">//å‚æ•°quitAllowed true: å¯é€€å‡º false: ä¸å¯é€€å‡º</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span> &#123;<br>     <span class="hljs-keyword">if</span> (sThreadLocal.get() != <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Only one Looper may be created per thread&quot;</span>);<br>     &#125;<br>     sThreadLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Looper</span>(quitAllowed));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘åˆæœ‰ä¸ªç–‘é—®ï¼Œä¸ºå•¥Looperä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨ç»™Newå‡ºæ¥å‘¢ï¼Ÿæˆ‘ä»¬ç‚¹å‡»å»Looperçš„æ„é€ æ–¹æ³•çœ‹ä¸€ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">Looper</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span> &#123;<br>  	 <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªMessageQueue,èµ‹å€¼ç»™å½“å‰Looperçš„mQueue</span><br>     mQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(quitAllowed);<br>  	 <span class="hljs-comment">//è·å–å½“å‰çº¿ç¨‹èµ‹å€¼ç»™Looperçš„mThread</span><br>     mThread = Thread.currentThread();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œä»–çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼ŒåŸæ¥å¦‚æ­¤ã€‚è€Œä¸”æˆ‘ä»¬è¿˜ä¼šå‘ç°ï¼šLooperçš„å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªMessageQueueï¼Œå½“åˆå§‹åŒ–Looperçš„æ—¶å€™ä¼šé¡ºå¸¦åˆå§‹åŒ–è¿™ä¸ªMessageQueue</p>
<h4 id="Looperå¼€å¯æ¶ˆæ¯å¾ªç¯"><a href="#Looperå¼€å¯æ¶ˆæ¯å¾ªç¯" class="headerlink" title="Looperå¼€å¯æ¶ˆæ¯å¾ªç¯"></a>Looperå¼€å¯æ¶ˆæ¯å¾ªç¯</h4><p>å½“æˆ‘ä»¬çš„Looperåˆ›å»ºå¥½åï¼Œä»–æ˜¯ä¸ä¼šè‡ªå·±å¯åŠ¨çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»å¯åŠ¨Looperï¼Œè°ƒç”¨Looperçš„<code>loop()</code>æ–¹æ³•å³å¯ï¼Œæ‰€ä»¥å‰é¢åˆ›å»ºLooperçš„æ—¶å€™æˆ‘æ€»æ˜¯ä¼šè¯´ï¼Œåˆ›å»ºLooperå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼ŒLooperçš„<code>prepare</code>å’Œ<code>loop</code>æ–¹æ³•æ˜¯é…å¥—ä½¿ç”¨çš„ï¼Œä¸¤è€…å¿…é¡»æˆå¯¹å­˜åœ¨ã€‚ç°åœ¨æˆ‘ä»¬æ¥é‡ç‚¹åˆ†æä¸€ä¸‹Looperçš„<code>loop</code>æ–¹æ³•ï¼Œä¸Šæºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„Looper</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Looper</span> <span class="hljs-variable">me</span> <span class="hljs-operator">=</span> myLooper();<br>    <span class="hljs-comment">//å½“å‰çº¿ç¨‹çš„Looper,ç›´æ¥æŠ›å¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (me == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);<br>    &#125;<br>  	<span class="hljs-comment">//è·å–å½“å‰Looperä¸­çš„MessageQueue</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> me.mQueue;<br>    <span class="hljs-comment">//...</span><br>  	<span class="hljs-comment">//å¼€å¯æ­»å¾ªç¯è¯»å–æ¶ˆæ¯</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">// è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> queue.next(); <span class="hljs-comment">// might block</span><br>        <span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// è¿”å›nullè¯´æ˜MessageQueueé€€å‡ºäº†</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨Messageå¯¹åº”çš„Handlerå¤„ç†æ¶ˆæ¯</span><br>            msg.target.dispatchMessage(msg);<br>            <span class="hljs-keyword">if</span> (observer != <span class="hljs-literal">null</span>) &#123;<br>                observer.messageDispatched(token, msg);<br>            &#125;<br>            dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">//...</span><br>    		<span class="hljs-comment">// å›æ”¶Message</span><br>        msg.recycleUnchecked();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>loop</code>æ–¹æ³•å°±æ˜¯Looperè¿™ä¸ªâ€œå¼•æ“â€çš„æ ¸å¿ƒæ‰€åœ¨ï¼Œä»–å°±åƒæ˜¯ä¸€ä¸ªå¼€å…³</p>
<p>åˆ†æä¸‹è¿™æ®µä»£ç ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹çš„Looperå¯¹è±¡ï¼Œæ²¡æœ‰åˆ™æŠ›å¼‚å¸¸ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯: ä¸æ–­è°ƒç”¨MessageQueueçš„nextæ–¹æ³•æ¥è·å–æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨messageçš„ç›®æ ‡handlerçš„<code>dispatchMessage</code>æ–¹æ³•æ¥å¤„ç†Messageã€‚</p>
<h4 id="Looperé€€å‡º"><a href="#Looperé€€å‡º" class="headerlink" title="Looperé€€å‡º"></a>Looperé€€å‡º</h4><p>Looperæä¾›äº†<code>quit</code>å’Œ<code>quitSafely</code>æ–¹æ³•æ¥é€€å‡ºä¸€ä¸ªLooperï¼ŒäºŒè€…çš„åŒºåˆ«æ˜¯ï¼š quitä¼šç›´æ¥é€€å‡ºLooperï¼Œè€ŒquitSafelyåªæ˜¯è®¾å®šä¸€ä¸ªæ ‡è®°ï¼Œç„¶åæŠŠæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å·²æœ‰æ¶ˆæ¯å¤„ç†å®Œæ¯•åæ‰å®‰å…¨é€€å‡º.åœ¨æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºLooperçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰€æœ‰çš„æ¶ˆæ¯éƒ½è¢«å¤„ç†å®Œæˆåï¼Œæˆ‘ä»¬åº”è¯¥è°ƒç”¨<code>quit</code>æ–¹æ³•æ¥ç»ˆæ­¢æ¶ˆæ¯å¾ªç¯ï¼Œå¦åˆ™å­çº¿ç¨‹å°±ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦‚æœé€€å‡ºLooperï¼Œè¿™ä¸ªçº¿ç¨‹å°±ä¼šç«‹åˆ»ç»ˆæ­¢ï¼Œå› æ­¤å»ºè®®ä¸éœ€è¦çš„æ—¶å€™ç»ˆæ­¢Looperã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quit</span><span class="hljs-params">()</span> &#123;<br>    mQueue.quit(<span class="hljs-literal">false</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quitSafely</span><span class="hljs-params">()</span> &#123;<br>    mQueue.quit(<span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-comment">// æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">quit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> safe)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœä¸èƒ½é€€å‡ºåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¸ªå€¼åœ¨åˆå§‹åŒ–Looperçš„æ—¶å€™è¢«èµ‹å€¼</span><br>    <span class="hljs-keyword">if</span> (!mQuitAllowed) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Main thread not allowed to quit.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-comment">// é€€å‡ºä¸€æ¬¡ä¹‹åå°±æ— æ³•å†æ¬¡è¿è¡Œäº†</span><br>        <span class="hljs-keyword">if</span> (mQuitting) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        mQuitting = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">// æ‰§è¡Œä¸åŒçš„æ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (safe) &#123;<br>            removeAllFutureMessagesLocked();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            removeAllMessagesLocked();<br>        &#125;<br>        <span class="hljs-comment">// å”¤é†’MessageQueue</span><br>        nativeWake(mPtr);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>quit</code>å’Œ<code>quitSafely</code>æ–¹æ³•æœ€ç»ˆéƒ½è°ƒç”¨äº†<code>quit(boolean safe)</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…ˆåˆ¤æ–­æ˜¯å¦èƒ½é€€å‡ºï¼Œç„¶åå†æ‰§è¡Œé€€å‡ºé€»è¾‘ã€‚å¦‚æœmQuitting&#x3D;&#x3D;trueï¼Œé‚£ä¹ˆè¿™é‡Œä¼šç›´æ¥returnæ‰ï¼Œæˆ‘ä»¬ä¼šå‘ç°mQuittingè¿™ä¸ªå˜é‡åªæœ‰åœ¨è¿™é‡Œè¢«æ‰§è¡Œäº†èµ‹å€¼ï¼Œæ‰€ä»¥ä¸€æ—¦looperé€€å‡ºï¼Œåˆ™æ— æ³•å†æ¬¡è¿è¡Œäº†ã€‚ä¹‹åæ‰§è¡Œä¸åŒçš„é€€å‡ºé€»è¾‘,ç„¶åå”¤é†’MessageQueue,ä¹‹åMessageQueueçš„nextæ–¹æ³•ä¼šé€€å‡ºï¼ŒLooperçš„loopæ–¹æ³•ä¹Ÿä¼šè·Ÿç€é€€å‡ºï¼Œé‚£ä¹ˆçº¿ç¨‹ä¹Ÿå°±åœæ­¢äº†ã€‚</p>
<h4 id="Looperæ€»ç»“"><a href="#Looperæ€»ç»“" class="headerlink" title="Looperæ€»ç»“"></a>Looperæ€»ç»“</h4><p>Looperä½œä¸ºHandleræ¶ˆæ¯æœºåˆ¶çš„â€œåŠ¨åŠ›å¼•æ“â€ï¼Œä¸æ–­ä»MessageQueueä¸­è·å–æ¶ˆæ¯ï¼Œç„¶åäº¤ç»™Handlerå»å¤„ç†ã€‚Looperçš„ä½¿ç”¨å‰éœ€è¦å…ˆåˆå§‹åŒ–å½“å‰çº¿ç¨‹çš„Looperå¯¹è±¡ï¼Œå†è°ƒç”¨loopæ–¹æ³•æ¥å¯åŠ¨å®ƒã€‚</p>
<p>åŒæ—¶Handlerä¹Ÿæ˜¯å®ç°åˆ‡æ¢çš„æ ¸å¿ƒï¼Œå› ä¸ºä¸åŒçš„Looperè¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œä»–æ‰€è°ƒç”¨çš„dispatchMessageæ–¹æ³•åˆ™è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œæ‰€ä»¥Messageçš„å¤„ç†å°±è¢«åˆ‡æ¢åˆ°Looperæ‰€åœ¨çš„çº¿ç¨‹äº†ã€‚å½“looperä¸å†ä½¿ç”¨æ—¶ï¼Œå¯è°ƒç”¨ä¸åŒçš„é€€å‡ºæ–¹æ³•æ¥é€€å‡ºä»–ï¼Œæ³¨æ„Looperä¸€æ—¦é€€å‡ºï¼Œçº¿ç¨‹åˆ™ä¼šç›´æ¥ç»“æŸã€‚</p>
<h3 id="Handlerå‘é€æ¶ˆæ¯"><a href="#Handlerå‘é€æ¶ˆæ¯" class="headerlink" title="Handlerå‘é€æ¶ˆæ¯"></a>Handlerå‘é€æ¶ˆæ¯</h3><p>Handlerå’ŒLooperéƒ½åˆ›å»ºå¥½äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦ä½¿ç”¨Handlerå»å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬åœ¨æœ€å¼€å§‹ä»‹ç»Handlerä½¿ç”¨çš„æ—¶å€™ï¼Œå†™äº†å‘é€çš„ä¸¤ç§æ¶ˆæ¯ç±»å‹ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åœ¨é€‚å½“çš„æ—¶æœºä½¿ç”¨Handlerå®ä¾‹å‘é€æ¶ˆæ¯</span><br>mHandler.sendMessage(message);<br>mHandler.post(runnable);<span class="hljs-comment">//Runnableä¼šè¢«å°è£…è¿›ä¸€ä¸ªMessage,æ‰€ä»¥å®ƒæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªMessage</span><br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨Handlerå‘é€æ¶ˆæ¯ï¼Œå®ƒæœ‰<code>send</code> æˆ–è€… <code>post</code>ç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œæœ€ç»ˆè¿™äº›å‘é€çš„æ–¹æ³•ä¼šè°ƒç”¨åˆ°Handlerä¸­çš„enqueueMessage()æ–¹æ³•ï¼Œè€ŒHandlerä¸­çš„<code>enqueueMessage</code>æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ°MessageQueueçš„<code>enqueueMessage</code>æ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå‘é€æ¶ˆæ¯æ–¹æ³•çš„æºç çœ‹ä¸‹ï¼Œä»¥æˆ‘ä»¬æœ€å¸¸ç”¨çš„sendMessage()è¿™ä¸ªæ–¹æ³•ä¸ºä¾‹ï¼š</p>
<p><strong>æ³¨æ„</strong>ï¼š<code>post</code>ç³»åˆ—æ–¹æ³•ï¼Œå‘é€çš„æ˜¯ä¸€ä¸ªRunnableï¼ŒRunnableä¼šè¢«å°è£…è¿›ä¸€ä¸ªMessageï¼Œæ‰€ä»¥å®ƒæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸€ä¸ªMessage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>    <span class="hljs-keyword">return</span> sendMessageDelayed(msg, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">//2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendMessageDelayed</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg, <span class="hljs-type">long</span> delayMillis)</span> &#123;<br>    <span class="hljs-keyword">if</span> (delayMillis &lt; <span class="hljs-number">0</span>) &#123;<br>      	delayMillis = <span class="hljs-number">0</span>;<br>    &#125;<br>   	<span class="hljs-keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);<br>&#125;<br><br><span class="hljs-comment">//3</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendMessageAtTime</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg, <span class="hljs-type">long</span> uptimeMillis)</span> &#123;<br>    <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> mQueue;<br>    <span class="hljs-keyword">if</span> (queue == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">RuntimeException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>        <span class="hljs-built_in">this</span> + <span class="hljs-string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);<br>        Log.w(<span class="hljs-string">&quot;Looper&quot;</span>, e.getMessage(), e);<br>       	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);<br>&#125;<br><br><span class="hljs-comment">//4</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MessageQueue queue, <span class="hljs-meta">@NonNull</span> Message msg,<span class="hljs-type">long</span> uptimeMillis)</span> &#123;<br>     <span class="hljs-comment">//å°†å½“å‰çš„Handlerèµ‹å€¼ç»™Messageçš„targetå±æ€§</span><br>  	 msg.target = <span class="hljs-built_in">this</span>;<br>     msg.workSourceUid = ThreadLocalWorkSource.getUid();<br><br>     <span class="hljs-keyword">if</span> (mAsynchronous) &#123;<br>         msg.setAsynchronous(<span class="hljs-literal">true</span>);<br>     &#125;<br>     <span class="hljs-keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç çš„è°ƒç”¨é¡ºåºå°±æ˜¯1-&gt;2-&gt;3-&gt;4</p>
<p>è¿™é‡Œæˆ‘ç»™ä¸€å¼ å›¾æ¥æ€»ç»“ä¸€ä¸‹ï¼Œ<code>send</code> æˆ–è€… <code>post</code>ç­‰ä¸€ç³»åˆ—æ–¹æ³•çš„è°ƒç”¨åŠæœ€ç»ˆçš„èµ°å‘ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72362e6cb08043fa8094f459fbd6291e~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload alt="image-20210131222442908"></p>
<h3 id="MessageQueue-enqueueMessageæ–¹æ³•ä»‹ç»"><a href="#MessageQueue-enqueueMessageæ–¹æ³•ä»‹ç»" class="headerlink" title="MessageQueue enqueueMessageæ–¹æ³•ä»‹ç»"></a>MessageQueue enqueueMessageæ–¹æ³•ä»‹ç»</h3><p>åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬å°±æ¥é‡ç‚¹åˆ†æä¸€ä¸‹MessageQueueçš„enqueueMessage()æ–¹æ³•ï¼ŒenqueueMessageä¸­æ–‡æ„æ€æ˜¯å…¥é˜Ÿæ¶ˆæ¯ï¼Œè§åçŸ¥æ„ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æŠŠHandlerå‘é€çš„æ¶ˆæ¯ï¼Œæ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(Message msg, <span class="hljs-type">long</span> when)</span> &#123;<br>    <span class="hljs-comment">// Hanlderä¸ºç©ºåˆ™æŠ›å¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (msg.target == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Message must have a target.&quot;</span>);<br>    &#125;<br>  	<span class="hljs-comment">//å½“å‰æ¶ˆæ¯å¦‚æœå·²ç»å·²ç»è¢«æ‰§è¡Œåˆ™æŠ›å¼‚å¸¸</span><br>    <span class="hljs-keyword">if</span> (msg.isInUse()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(msg + <span class="hljs-string">&quot; This message is already in use.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// å¯¹MessageQueueè¿›è¡ŒåŠ é”</span><br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­ç›®æ ‡threadæ˜¯å¦å·²ç»æ­»äº¡</span><br>        <span class="hljs-keyword">if</span> (mQuitting) &#123;<br>            <span class="hljs-type">IllegalStateException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>                    msg.target + <span class="hljs-string">&quot; sending message to a Handler on a dead thread&quot;</span>);<br>            Log.w(TAG, e.getMessage(), e);<br>            msg.recycle();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// æ ‡è®°Messageæ­£åœ¨è¢«æ‰§è¡Œï¼Œä»¥åŠéœ€è¦è¢«æ‰§è¡Œçš„æ—¶é—´</span><br>        <span class="hljs-comment">//è¿™é‡Œçš„whençš„å€¼éœ€è¦åˆ†æƒ…å†µ:1,å¯èƒ½ä¸º0 2, å¦‚æœä¸ä¸º0ï¼Œåˆ™æ˜¯ç³»ç»Ÿå¼€æœºåˆ°ç°åœ¨çš„ä¸€ä¸ªæ¯«ç§’æ•° + å»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´</span><br>        <span class="hljs-comment">//è¿™ä¸¤ç§æƒ…å†µä¸»è¦çœ‹ä½ è°ƒç”¨çš„æ˜¯Handlerå“ªä¸ªå‘é€Messageçš„æ–¹æ³•</span><br>        msg.markInUse();<br>        msg.when = when;<br>        <span class="hljs-comment">// pæ˜¯MessageQueueçš„é“¾è¡¨å¤´</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mMessages;<br>      	<span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’MessageQueue</span><br>        <span class="hljs-type">boolean</span> needWake;<br>        <span class="hljs-comment">// å¦‚æœæœ‰æ–°çš„é˜Ÿå¤´ï¼ŒåŒæ—¶MessageQueueå¤„äºé˜»å¡çŠ¶æ€åˆ™éœ€è¦å”¤é†’é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">null</span> || when == <span class="hljs-number">0</span> || when &lt; p.when) &#123;<br>            msg.next = p;<br>            mMessages = msg;<br>            needWake = mBlocked;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//...</span><br>            <span class="hljs-comment">// æ ¹æ®æ—¶é—´æ‰¾åˆ°æ’å…¥çš„ä½ç½®</span><br>            Message prev;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                prev = p;<br>                p = p.next;<br>                <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">null</span> || when &lt; p.when) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">//...</span><br>            &#125;<br>            msg.next = p; <br>            prev.next = msg;<br>        &#125;<br><br>        <span class="hljs-comment">// å¦‚æœéœ€è¦åˆ™å”¤é†’é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">if</span> (needWake) &#123;<br>            nativeWake(mPtr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹:</p>
<ol>
<li><p>é¦–å…ˆåˆ¤æ–­Messageä¸­çš„Handlerä¸èƒ½ä¸ç©ºï¼Œä¸”ä¸èƒ½ä¸ºåœ¨ä½¿ç”¨ä¸­ï¼Œå¦åˆ™æŠ›å¼‚å¸¸</p>
</li>
<li><p>å¯¹MessageQueueè¿›è¡ŒåŠ é”ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦deadï¼Œå¦‚æœdeadåˆ™æ‰“å°ä¸€ä¸ªå¼‚å¸¸ï¼Œå¹¶è¿”å›false</p>
</li>
<li><p>åˆå§‹åŒ–Messageçš„æ‰§è¡Œæ—¶é—´ä»¥å¹¶ä¸”æ ‡è®°ä¸ºæ­£åœ¨æ‰§è¡Œä¸­</p>
</li>
<li><p>å½“æ–°æ’å…¥çš„Messageåœ¨é“¾è¡¨å¤´æ—¶ï¼Œå¦‚æœmessageQueueæ˜¯ç©ºçš„æˆ–è€…æ­£åœ¨ç­‰å¾…ä¸‹ä¸ªå»¶è¿Ÿæ¶ˆæ¯ï¼Œåˆ™éœ€è¦å”¤é†’MessageQueue</p>
</li>
<li><p>æ ¹æ®Messageçš„æ‰§è¡Œæ—¶é—´ï¼Œæ‰¾åˆ°åœ¨é“¾è¡¨ä¸­çš„æ’å…¥ä½ç½®è¿›è¡Œæ’å…¥ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç†è§£MessageQueueä¸­ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—,</p>
<p>ä¼˜å…ˆçº§é˜Ÿåˆ—å°±æ˜¯é“¾è¡¨æ ¹æ®æ—¶é—´è¿›è¡Œæ’åºå¹¶åŠ å…¥é˜Ÿåˆ—çš„æ•°æ®ç»“æ„å½¢æˆçš„ï¼Œä¾‹å¦‚æˆ‘ä»¬å‘é€çš„å‡ ä¸ªæ¶ˆæ¯æºå¸¦çš„æ—¶é—´åˆ†åˆ«ä¸ºï¼š1sï¼Œ20msï¼Œ3sï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šæ ¹æ®æ—¶é—´è¿›è¡Œæ’åºä¸ºï¼š20msï¼Œ1sï¼Œ3sï¼Œ é‚£ä¹ˆå¦‚æœæˆ‘æ–°åŠ å…¥çš„ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶é—´ä¸º2sï¼Œé‚£ä¹ˆä»–å°±ä¼šæ’å…¥1så’Œ3sçš„ä¸­é—´ï¼Œæ­¤æ—¶è¿™ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—å°±æœ‰äº†4ä¸ªå…ƒç´ ï¼š 20msï¼Œ1sï¼Œ2sï¼Œ3s</p>
</li>
</ol>
<h3 id="MessageQueue-nextæ–¹æ³•ä»‹ç»"><a href="#MessageQueue-nextæ–¹æ³•ä»‹ç»" class="headerlink" title="MessageQueue nextæ–¹æ³•ä»‹ç»"></a>MessageQueue nextæ–¹æ³•ä»‹ç»</h3><p>åˆ°è¿™é‡Œï¼ŒHandlerå‘é€çš„æ¶ˆæ¯å·²ç»æ”¾åˆ°äº†MessageQueueä¸­ï¼Œé‚£æ¥ç€è‚¯å®šå°±è¦è¿›è¡Œæ¶ˆæ¯çš„è¯»å–ï¼Œæˆ‘ä»¬åˆšè®²åˆ°Looperçš„<code>Loop</code>æ–¹æ³•ä¼šä»MessageQueueä¸­å¾ªç¯è¯»å–æ¶ˆæ¯ï¼Œ<code>loop</code>æ–¹æ³•ä¸­è°ƒç”¨<code>queue.next()</code>çš„åœ°æ–¹æœ‰å¥æºç æ³¨é‡Šï¼šmight block,ä¸­æ–‡æ„æ€æ˜¯å¯èƒ½è¢«é˜»å¡ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>  	<span class="hljs-comment">//è·å–å½“å‰Looperä¸­çš„MessageQueue</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> me.mQueue;<br>    <span class="hljs-comment">//...</span><br>  	<span class="hljs-comment">//å¼€å¯æ­»å¾ªç¯è¯»å–æ¶ˆæ¯</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>      <span class="hljs-comment">// è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> queue.next(); <span class="hljs-comment">// might block</span><br>    &#125;<br>  	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°±çœ‹ä¸‹MessageQueueçš„<code>next</code>æ–¹æ³•åˆ°åº•åšäº†ä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Return here if the message loop has already quit and been disposed.</span><br>    <span class="hljs-comment">// æºç ä¸­çš„æ³¨é‡Šè¡¨ç¤º:å¦‚æœlooperå·²ç»é€€å‡ºäº†,è¿™é‡Œå°±è¿”å›null</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ptr</span> <span class="hljs-operator">=</span> mPtr;<br>    <span class="hljs-keyword">if</span> (ptr == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-comment">// å®šä¹‰é˜»å¡æ—¶é—´èµ‹å€¼ä¸º0</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">nextPollTimeoutMillis</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  	<span class="hljs-comment">//æ­»å¾ªç¯</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">if</span> (nextPollTimeoutMillis != <span class="hljs-number">0</span>) &#123;<br>            Binder.flushPendingCommands();<br>        &#125;<br>        <span class="hljs-comment">// é˜»å¡å¯¹åº”æ—¶é—´ è¿™ä¸ªæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ°linuxçš„epollæœºåˆ¶</span><br>        nativePollOnce(ptr, nextPollTimeoutMillis);<br>    		<span class="hljs-comment">// å¯¹MessageQueueè¿›è¡ŒåŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span><br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> SystemClock.uptimeMillis();<br>            <span class="hljs-type">Message</span> <span class="hljs-variable">prevMsg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mMessages;<br>            <span class="hljs-comment">//...</span><br>            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (now &lt; msg.when) &#123;<br>                    <span class="hljs-comment">// ä¸‹ä¸€ä¸ªæ¶ˆæ¯è¿˜æ²¡å¼€å§‹ï¼Œç­‰å¾…ä¸¤è€…çš„æ—¶é—´å·®</span><br>                    nextPollTimeoutMillis = (<span class="hljs-type">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// è·å¾—æ¶ˆæ¯ä¸”ç°åœ¨è¦æ‰§è¡Œï¼Œæ ‡è®°MessageQueueä¸ºéé˜»å¡</span><br>                    mBlocked = <span class="hljs-literal">false</span>;<br>                    <span class="hljs-comment">// é“¾è¡¨æ“ä½œ</span><br>                    <span class="hljs-keyword">if</span> (prevMsg != <span class="hljs-literal">null</span>) &#123;<br>                        prevMsg.next = msg.next;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        mMessages = msg.next;<br>                    &#125;<br>                    msg.next = <span class="hljs-literal">null</span>;<br>                    msg.markInUse();<br>                    <span class="hljs-keyword">return</span> msg;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// æ²¡æœ‰æ¶ˆæ¯ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</span><br>                nextPollTimeoutMillis = -<span class="hljs-number">1</span>;<br>            &#125;<br>          	<span class="hljs-comment">//é€€å‡º</span><br>          	<span class="hljs-keyword">if</span> (mQuitting) &#123;<br>                 dispose();<br>                 <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>             &#125;<br>            <span class="hljs-comment">//...æ¶‰åŠäº†åŒæ­¥å±éšœå’ŒIdleHandler,åç»­åœ¨åˆ†æ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬å‘ç°<code>next</code>æ–¹æ³•ç›®çš„æ˜¯è·å–MessageQueueä¸­çš„ä¸€ä¸ªMessageï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œé‚£ä¹ˆnextæ–¹æ³•ä¼šä¸€ç›´é˜»å¡åœ¨è¿™é‡Œï¼Œå½“æœ‰æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œå°±ä¼šå°†å®ƒå”¤é†’ï¼Œnextæ–¹æ³•ä¼šè¿”å›è¿™æ¡æ¶ˆæ¯å¹¶å°†å…¶ä»ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ç»™ç§»é™¤</p>
<p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœLooperå·²ç»é€€å‡ºäº†ï¼Œç›´æ¥è¿”å›null</li>
<li>è¿›å…¥æ­»å¾ªç¯ï¼Œç›´åˆ°è·å–åˆ°Messageæˆ–è€…é€€å‡º</li>
<li>å¾ªç¯ä¸­å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œé˜»å¡ï¼Œé˜»å¡æœ€ç»ˆä¼šè°ƒç”¨åˆ°linuxçš„epollæœºåˆ¶ï¼Œé˜»å¡ç»“æŸå,å¯¹MessageQueueè¿›è¡ŒåŠ é”ï¼Œè·å–Message</li>
<li>å¦‚æœMessageQueueä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥æŠŠçº¿ç¨‹æ— é™é˜»å¡ç­‰å¾…å”¤é†’</li>
<li>å¦‚æœMessageQueueä¸­æœ‰æ¶ˆæ¯ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå¦åˆ™åˆ™ç›´æ¥è¿”å›å¯¹åº”çš„message</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°é€»è¾‘å°±æ˜¯åˆ¤æ–­å½“å‰æ—¶é—´Messageä¸­æ˜¯å¦éœ€è¦ç­‰å¾….å…¶ä¸­<code>nextPollTimeoutMillis</code>è¡¨ç¤ºé˜»å¡çš„æ—¶é—´ï¼Œ<code>-1</code>è¡¨ç¤ºæ— é™æ—¶é—´,ç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿä¸ºæ­¢ï¼Œ<code>0</code>è¡¨ç¤ºä¸é˜»å¡</p>
<h3 id="Handleræ¥æ”¶æ¶ˆæ¯"><a href="#Handleræ¥æ”¶æ¶ˆæ¯" class="headerlink" title="Handleræ¥æ”¶æ¶ˆæ¯"></a>Handleræ¥æ”¶æ¶ˆæ¯</h3><p>åœ¨æˆ‘ä»¬å¯¹Looperè¿›è¡Œæ€»ç»“æ—¶æˆ‘ä»¬è¯´äº†ï¼š Handlerä¹Ÿæ˜¯å®ç°çº¿ç¨‹åˆ‡æ¢çš„æ ¸å¿ƒï¼Œå› ä¸ºä¸åŒçš„Looperè¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œä»–æ‰€è°ƒç”¨çš„dispatchMessageæ–¹æ³•åˆ™ä¼šè¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œæ‰€ä»¥Messageçš„å¤„ç†å°±ä¼šè¢«åˆ‡æ¢åˆ°Looperæ‰€åœ¨çš„çº¿ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>      	<span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨Messageå¯¹åº”çš„Handlerå¤„ç†æ¶ˆæ¯</span><br>            msg.target.dispatchMessage(msg);<br>        &#125;<br> 				<span class="hljs-comment">//...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç è°ƒç”¨äº† <code>msg.target.dispatchMessage(msg)</code> æ–¹æ³•ï¼Œmsg.target å°±æ˜¯å‘é€è¯¥æ¶ˆæ¯çš„ Handlerï¼Œè¿™æ ·æ¶ˆæ¯æœ€ç»ˆä¼šå›è°ƒåˆ°Handlerçš„<code>dispatchMessage</code>æ–¹æ³•ä¸­ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>  	<span class="hljs-comment">//æ¶ˆæ¯çš„callbackä¸ä¸ºç©º,åˆ™å›è°ƒhandleCallbackæ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (msg.callback != <span class="hljs-literal">null</span>) &#123;<br>        handleCallback(msg);<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>      		<span class="hljs-comment">//å½“å‰mCallbackä¸ä¸ºç©º,å›è°ƒmCallback.handleMessageæ–¹æ³•</span><br>     			<span class="hljs-keyword">if</span> (mCallback != <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-keyword">if</span> (mCallback.handleMessage(msg)) &#123;<br>                  <span class="hljs-keyword">return</span>;<br>              &#125;<br>          &#125;<br>      		<span class="hljs-comment">//å›è°ƒhandleMessage</span><br>          handleMessage(msg);<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æ­¥éª¤:</p>
<p>1ã€é¦–å…ˆï¼Œæ£€æŸ¥Messageçš„callbackæ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullå°±é€šè¿‡<code>handleCallBack</code>æ¥å¤„ç†æ¶ˆæ¯ï¼ŒMessageçš„callbackæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯Handlerçš„<code>post</code>ç³»åˆ—æ–¹æ³•æ‰€ä¼ é€’çš„Runnableå‚æ•°ï¼Œ<code>handleCallBack</code>æ–¹æ³•å¤„ç†é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCallback</span><span class="hljs-params">(Message message)</span> &#123;<br>     message.callback.run();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2ã€å…¶æ¬¡ï¼Œæ£€æŸ¥mCallbackæ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullå°±è°ƒç”¨mCallbackçš„<code>handleMessage</code>æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ã€‚Callbackæ˜¯ä¸ªæ¥å£ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Callback interface you can use when instantiating a Handler to avoid</span><br><span class="hljs-comment"> * having to implement your own subclass of Handler.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡Callbackå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼æ¥åˆ›å»ºHandlereå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Handler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(callback);<br></code></pre></td></tr></table></figure>

<p>é‚£Callbackçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæºç é‡Œæ³¨é‡Šåšäº†è¯´æ˜ï¼šå¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªHandlerçš„å®ä¾‹ä½†å¹¶ä¸éœ€è¦æ´¾ç”Ÿçš„å­ç±»ã€‚åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œåˆ›å»ºHandleræœ€å¸¸è§çš„å°±æ˜¯æ´¾ç”Ÿä¸€ä¸ªHandlerçš„å­ç±»å¹¶é‡å†™å…¶<code>handleMessage</code>æ–¹æ³•æ¥å¤„ç†å…·ä½“çš„æ¶ˆæ¯ï¼Œè€ŒCallbackç»™æˆ‘ä»¬æä¾›äº†å¦å¤–ä¸€ç§ä½¿ç”¨Handlerçš„æ–¹å¼ï¼Œå½“æˆ‘ä»¬ä¸æƒ³æ´¾ç”Ÿå­ç±»æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡Callbackæ¥å®ç°ã€‚</p>
<p>3ã€æœ€åï¼Œè°ƒç”¨Handlerçš„<code>handleMessage</code>æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯</p>
<p>Handlerå¤„ç†æ¶ˆæ¯çš„è¿‡ç¨‹æˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2849c508f7a342e9b53f2b8384066c57~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload alt="image-20210131222054614"></p>
<h3 id="Messageä»‹ç»"><a href="#Messageä»‹ç»" class="headerlink" title="Messageä»‹ç»"></a>Messageä»‹ç»</h3><p>Messageæ˜¯è´Ÿè´£æ‰¿è½½æ¶ˆæ¯çš„ç±»ï¼Œä¸»è¦æ˜¯å…³æ³¨ä»–çš„å†…éƒ¨å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä¸»è¦ç”¨äºè¾¨åˆ«Messageçš„ç±»å‹</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> what;<br><span class="hljs-comment">// ç”¨äºå­˜å‚¨ä¸€äº›æ•´å‹æ•°æ®</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> arg1;<br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> arg2;<br><span class="hljs-comment">// å¯æ”¾å…¥ä¸€ä¸ªå¯åºåˆ—åŒ–å¯¹è±¡</span><br><span class="hljs-keyword">public</span> Object obj;<br><span class="hljs-comment">// Bundleæ•°æ®</span><br>Bundle data;<br><span class="hljs-comment">// Messageå¤„ç†çš„æ—¶é—´ã€‚ç›¸å¯¹äº1970.1.1è€Œè¨€çš„æ—¶é—´</span><br><span class="hljs-comment">// å¯¹ç”¨æˆ·ä¸å¯è§</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> when;<br><span class="hljs-comment">// å¤„ç†è¿™ä¸ªMessageçš„Handler</span><br><span class="hljs-comment">// å¯¹ç”¨æˆ·ä¸å¯è§</span><br>Handler target;<br><span class="hljs-comment">// å½“æˆ‘ä»¬ä½¿ç”¨Handlerçš„postæ–¹æ³•æ—¶å€™å°±æ˜¯æŠŠrunnableå¯¹è±¡å°è£…æˆMessage</span><br><span class="hljs-comment">// å¯¹ç”¨æˆ·ä¸å¯è§</span><br>Runnable callback;<br><span class="hljs-comment">// MessageQueueæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œnextè¡¨ç¤ºä¸‹ä¸€ä¸ª</span><br><span class="hljs-comment">// å¯¹ç”¨æˆ·ä¸å¯è§</span><br>Message next;<br></code></pre></td></tr></table></figure>

<h4 id="å¾ªç¯åˆ©ç”¨Message"><a href="#å¾ªç¯åˆ©ç”¨Message" class="headerlink" title="å¾ªç¯åˆ©ç”¨Message"></a>å¾ªç¯åˆ©ç”¨Message</h4><p>å½“æˆ‘ä»¬è·å–Messageçš„æ—¶å€™ï¼Œå®˜æ–¹å»ºè®®æ˜¯é€šè¿‡Message.obtain()æ–¹æ³•æ¥è·å–ï¼Œå½“ä½¿ç”¨å®Œä¹‹åä½¿ç”¨recycle()æ–¹æ³•æ¥å›æ”¶å¾ªç¯åˆ©ç”¨ã€‚è€Œä¸æ˜¯ç›´æ¥newä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title function_">obtain</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (sPoolSync) &#123;<br>        <span class="hljs-keyword">if</span> (sPool != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> sPool;<br>            sPool = m.next;<br>            m.next = <span class="hljs-literal">null</span>;<br>            m.flags = <span class="hljs-number">0</span>; <br>            sPoolSize--;<br>            <span class="hljs-keyword">return</span> m;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Messageç»´æŠ¤äº†ä¸€ä¸ªé™æ€é“¾è¡¨ï¼Œé“¾è¡¨å¤´æ˜¯<code>sPool</code>ï¼ŒMessageæœ‰ä¸€ä¸ªnextå±æ€§ï¼ŒMessageæœ¬èº«å°±æ˜¯é“¾è¡¨ç»“æ„ã€‚<code>sPoolSync</code>æ˜¯ä¸€ä¸ªobjectå¯¹è±¡ï¼Œä»…ä½œä¸ºè§£å†³å¹¶å‘è®¿é—®å®‰å…¨è®¾è®¡ã€‚å½“æˆ‘ä»¬è°ƒç”¨obtainæ¥è·å–ä¸€ä¸ªæ–°çš„Messageçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæ£€æŸ¥é“¾è¡¨ä¸­æ˜¯å¦æœ‰ç©ºé—²çš„Messageï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºä¸€ä¸ªè¿”å›ã€‚</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨å®Œæˆä¹‹åï¼Œå¯ä»¥è°ƒç”¨Messageçš„recycleæ–¹æ³•è¿›è¡Œå›æ”¶ï¼Œå¦‚æœè¿™ä¸ªMessageæ­£åœ¨ä½¿ç”¨åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™åˆ™è°ƒç”¨<code>recycleUnchecked</code>è¿›è¡Œå›æ”¶ï¼ŒæŠŠMessageä¸­çš„å†…å®¹æ¸…ç©ºï¼Œç„¶ååˆ¤æ–­é“¾è¡¨æ˜¯å¦è¾¾åˆ°æœ€å¤§å€¼ï¼ˆ50ï¼‰ï¼Œç„¶åæ’å…¥é“¾è¡¨ä¸­</p>
<h2 id="Handleræ¶ˆæ¯æœºåˆ¶åŸç†æ€»ç»“"><a href="#Handleræ¶ˆæ¯æœºåˆ¶åŸç†æ€»ç»“" class="headerlink" title="Handleræ¶ˆæ¯æœºåˆ¶åŸç†æ€»ç»“"></a>Handleræ¶ˆæ¯æœºåˆ¶åŸç†æ€»ç»“</h2><p>é€šè¿‡ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p>
<ol>
<li>å®ä¾‹åŒ–Handlerä¹‹å‰ï¼Œéœ€å…ˆæ„å»ºå½“å‰çº¿ç¨‹çš„Looperå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯</li>
<li>é€šè¿‡Handlerçš„sendå’Œpostæ–¹æ³•å‘é€æ¶ˆæ¯</li>
<li>å‘é€çš„æ¶ˆæ¯ä¼šåŠ å…¥åˆ°MessageQueueä¸­ï¼Œç­‰å¾…Looperè·å–å¤„ç†</li>
<li>Looperä¼šä¸æ–­åœ°ä»MessageQueueä¸­è·å–Messageç„¶åäº¤ä»˜ç»™å¯¹åº”çš„Handlerå¤„ç†</li>
</ol>
<p>å¦‚æœåˆ°è¿™é‡Œä½ è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šHandleræ¶ˆæ¯æœºåˆ¶çš„åŸç†ï¼Œé‚£ä¹ˆç»§ç»­çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c76ccdd09feb4aa2a41ba0789da36c38~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload></p>
<p>å¥½äº†ï¼Œåˆ°äº†è¿™é‡Œï¼Œå…³äºHandleræ¶ˆæ¯æœºåˆ¶çš„ä¸»ä½“éƒ¨åˆ†å°±è®²å®Œäº†ã€‚</p>
<p>é™äºç¯‡å¹…ï¼Œæœ¬ç¯‡æ–‡ç« å°±åˆ°è¿™é‡Œäº†ï¼Œåç»­æˆ‘ä¼šåœ¨å†™ä¸€ç¯‡å…³äºHandlerçš„æ–‡ç« ï¼Œä»‹ç»Hanlderçš„ä¸€äº›æ‰©å±•çŸ¥è¯†å­¦ä¹ ï¼Œå¹¶å›ç­”å‰é¢æˆ‘æ‰€åˆ—å‡ºæ¥çš„ä¸€ç³»åˆ—é—®é¢˜</p>
<blockquote>
<p><strong>ä½ çš„ç‚¹èµï¼Œè¯„è®ºï¼Œæ˜¯å¯¹æˆ‘å·¨å¤§çš„é¼“åŠ±ï¼</strong></p>
<p>æ¬¢è¿å…³æ³¨æˆ‘çš„<strong>å…¬ä¼—å·ï¼š</strong>  <a target="_blank" rel="noopener" href="http://m6z.cn/6jwi7b"><strong>sweetying</strong></a> ï¼Œæ–‡ç« æ›´æ–°å¯ç¬¬ä¸€æ—¶é—´æ”¶åˆ°</p>
<p>å¦‚æœ<strong>æœ‰é—®é¢˜</strong>ï¼Œå…¬ä¼—å·å†…æœ‰åŠ æˆ‘å¾®ä¿¡çš„å…¥å£ï¼Œåœ¨æŠ€æœ¯å­¦ä¹ ã€ä¸ªäººæˆé•¿çš„é“è·¯ä¸Šï¼Œæˆ‘ä»¬ä¸€èµ·å‰è¿›ï¼</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Android/" class="category-chain-item">Android</a>
  
  
    <span>></span>
    
  <a href="/categories/Android/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F/" class="category-chain-item">ä¸€ç¯‡å°±å¤Ÿ</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8E%9F%E5%88%9B/">#åŸåˆ›</a>
      
        <a href="/tags/Android/">#Android</a>
      
        <a href="/tags/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F/">#ä¸€ç¯‡å°±å¤Ÿ</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ</div>
      <div>https://sweetying520.github.io/2022/10/11/ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>sweetying</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´10æœˆ11æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9AHandler%E6%89%A9%E5%B1%95%E7%AF%87/" title="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9A%E5%8F%91%E5%B8%83%E5%BC%80%E6%BA%90%E5%BA%93%E5%88%B0JitPack%EF%BC%8CJCenter%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/" title="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šå‘å¸ƒå¼€æºåº“åˆ°JitPackï¼ŒJCenterè¯¦ç»†æ•™ç¨‹">
                        <span class="hidden-mobile">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šå‘å¸ƒå¼€æºåº“åˆ°JitPackï¼ŒJCenterè¯¦ç»†æ•™ç¨‹</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"zN1E017kYhKuj6GqXHJSbGMb-gzGzoHsz","appKey":"JSwY8PjtA131Y78OHn7kKtio","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
