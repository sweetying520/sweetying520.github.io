

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sweetying">
  <meta name="keywords" content="">
  
    <meta name="description" content="å‰è¨€ Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š ç¬¬ä¸€ç¯‡ï¼šâ€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ ç¬¬äºŒç¯‡ï¼š â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡  åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å¯¹Handlerçš„ä¸»ä½“éƒ¨åˆ†è¿›è¡Œäº†è®²è§£ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹Handlerç›¸å…³çš„ä¸€äº›æ‰©å±•çŸ¥è¯†ï¼Œè®²å®Œè¿™äº›æ‰©å±•çŸ¥è¯†åï¼Œåœ¨æ¥å›ç­”ä¹‹å‰åˆ—å‡ºæ¥çš„ä¸€ç³»åˆ—é—®é¢˜ åŒæ­¥å±éšœé€šè¿‡ä¸Šä¸€ç¯‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“: Handlerå‘é€çš„Messageä¼šæ”¾å…¥åˆ°Mes">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡">
<meta property="og:url" content="https://sweetying520.github.io/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9AHandler%E6%89%A9%E5%B1%95%E7%AF%87/index.html">
<meta property="og:site_name" content="sweetying">
<meta property="og:description" content="å‰è¨€ Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š ç¬¬ä¸€ç¯‡ï¼šâ€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ ç¬¬äºŒç¯‡ï¼š â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡  åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å¯¹Handlerçš„ä¸»ä½“éƒ¨åˆ†è¿›è¡Œäº†è®²è§£ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹Handlerç›¸å…³çš„ä¸€äº›æ‰©å±•çŸ¥è¯†ï¼Œè®²å®Œè¿™äº›æ‰©å±•çŸ¥è¯†åï¼Œåœ¨æ¥å›ç­”ä¹‹å‰åˆ—å‡ºæ¥çš„ä¸€ç³»åˆ—é—®é¢˜ åŒæ­¥å±éšœé€šè¿‡ä¸Šä¸€ç¯‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“: Handlerå‘é€çš„Messageä¼šæ”¾å…¥åˆ°Mes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79f6a7b7e65d4c1ea07ea76b3ac49689~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4fb7b199888404f864e1d0c43d0dc7f~tplv-k3u1fbpfcp-zoom-1.image">
<meta property="article:published_time" content="2022-10-11T02:50:51.000Z">
<meta property="article:modified_time" content="2022-10-11T03:18:28.550Z">
<meta property="article:author" content="sweetying">
<meta property="article:tag" content="åŸåˆ›">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="ä¸€ç¯‡å°±å¤Ÿ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79f6a7b7e65d4c1ea07ea76b3ac49689~tplv-k3u1fbpfcp-zoom-1.image">
  
  
  
  <title>ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡ - sweetying</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sweetying520.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"zN1E017kYhKuj6GqXHJSbGMb-gzGzoHsz","app_key":"JSwY8PjtA131Y78OHn7kKtio","server_url":"https://zn1e017k.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sweetying</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        sweetying
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-11 10:50" pubdate>
          2022å¹´10æœˆ11æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          189 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote>
<p>Handlerç³»åˆ—æ–‡ç« å…±ä¸¤ç¯‡ï¼š</p>
<p>ç¬¬ä¸€ç¯‡ï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6924084444609544199#heading-5">â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ</a></p>
<p>ç¬¬äºŒç¯‡ï¼š <a target="_blank" rel="noopener" href="https://juejin.cn/post/6932608660354891790/">â€œä¸€ç¯‡å°±å¤Ÿâ€ç³»åˆ—: Handleræ‰©å±•ç¯‡</a></p>
</blockquote>
<p>åœ¨<a target="_blank" rel="noopener" href="https://juejin.cn/post/6924084444609544199">ä¸Šä¸€ç¯‡</a>ä¸­ï¼Œæˆ‘ä»¬å¯¹Handlerçš„ä¸»ä½“éƒ¨åˆ†è¿›è¡Œäº†è®²è§£ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹Handlerç›¸å…³çš„ä¸€äº›æ‰©å±•çŸ¥è¯†ï¼Œè®²å®Œè¿™äº›æ‰©å±•çŸ¥è¯†åï¼Œåœ¨æ¥å›ç­”ä¹‹å‰åˆ—å‡ºæ¥çš„ä¸€ç³»åˆ—é—®é¢˜</p>
<h2 id="åŒæ­¥å±éšœ"><a href="#åŒæ­¥å±éšœ" class="headerlink" title="åŒæ­¥å±éšœ"></a>åŒæ­¥å±éšœ</h2><p>é€šè¿‡ä¸Šä¸€ç¯‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“: Handlerå‘é€çš„Messageä¼šæ”¾å…¥åˆ°MessageQueueä¸­ï¼ŒMessageQueueä¸­ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—çš„æ„æ€å°±æ˜¯å°†å­˜å‚¨æ•°æ®çš„å•é“¾è¡¨æŒ‰ç…§æ—¶é—´å‡åºè¿›è¡Œæ’åºå½¢æˆçš„ï¼ŒLooperåˆ™æŒ‰ç…§é¡ºåºï¼Œæ¯æ¬¡ä»è¿™ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªMessageè¿›è¡Œåˆ†å‘ï¼Œä¸€ä¸ªå¤„ç†å®Œå°±å¤„ç†ä¸‹ä¸€ä¸ªã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæˆ‘èƒ½ä¸èƒ½è®©æˆ‘çš„ä¸€ä¸ªMessageè¢«ä¼˜å…ˆå¤„ç†ï¼Ÿ</p>
<p>å¯ä»¥ï¼Œä½¿ç”¨åŒæ­¥å±éšœ</p>
<p>è¿™é‡Œï¼Œæˆ‘å¿ƒé‡Œåˆä¼šæœ‰ä¸ªç–‘é—®ï¼Œä»€ä¹ˆæ˜¯åŒæ­¥å±éšœï¼Ÿæ€ä¹ˆä½¿ç”¨åŒæ­¥å±éšœï¼ŸåŒæ­¥å±éšœæœ‰å•¥ä½œç”¨ï¼Ÿå¸¦ç€è¿™äº›ç–‘é—®ğŸ¤”ï¸ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹æºç </p>
<p>å…ˆçœ‹ä¸‹MessageQueueçš„<code>next</code>æ–¹æ³•ï¼Œåœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œå…¶ä¸­æœ‰ä¸€éƒ¨åˆ†æ˜¯è¿™æ ·å­çš„ï¼Œä»…è´´å‡ºå…³é”®ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; msg.target == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span><br>                <span class="hljs-keyword">do</span> &#123;<br>                     prevMsg = msg;<br>                     msg = msg.next;<br>                &#125; <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !msg.isAsynchronous());<br>            &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ï¼š</p>
<p>1ã€åˆ¤æ–­å½“å‰msgä¸ä¸ºç©ºå¹¶ä¸”msg.targetä¸ºç©ºï¼Œåˆ™è¿›å…¥æ¡ä»¶ä½“é‡Œé¢</p>
<p>2ã€æ¡ä»¶ä½“é‡Œé¢æœ‰ä¸€è¡Œæºç æ³¨é‡Šï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯: <strong>è¢«ä¸€ä¸ªå±éšœç»™é˜»ç¢ã€‚åœ¨é˜Ÿåˆ—ä¸­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯</strong></p>
<p>3ã€æ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œéå†æ‰¾å‡ºä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ï¼Œå¾ªç¯ä½“é‡Œé¢å°±æ˜¯é“¾è¡¨ç›¸å…³çš„æ“ä½œ</p>
<p>è¿™é‡Œå¤§å®¶æ˜¯ä¸æ˜¯ä¼šæœ‰ä¸ªç–‘é—®ï¼Ÿmsg.targetæ€ä¹ˆå¯èƒ½ä¼šä¸ºç©ºå‘¢ï¼Ÿä¹‹å‰å‘é€æ¶ˆæ¯çš„ä¸€ç³»åˆ—æ–¹æ³•ä¸æ˜¯éƒ½ä¼šç»™msg.targetå¯¹è±¡èµ‹å€¼å—ï¼Ÿ</p>
<p>æ²¡é”™ï¼Œæˆ‘ä»¬åœ¨å›é¡¾ä¸€ä¸‹Handlerçš„<code>enqueueMessage</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MessageQueue queue, <span class="hljs-meta">@NonNull</span> Message msg,<span class="hljs-type">long</span> uptimeMillis)</span> &#123;<br>     <span class="hljs-comment">//å°†å½“å‰Handlerèµ‹å€¼ç»™msg.target</span><br>     msg.target = <span class="hljs-built_in">this</span>;<br>     msg.workSourceUid = ThreadLocalWorkSource.getUid();<br>     <span class="hljs-keyword">if</span> (mAsynchronous) &#123;<br>         msg.setAsynchronous(<span class="hljs-literal">true</span>);<br>     &#125;<br>     <span class="hljs-comment">//è°ƒç”¨MessageQueueçš„enqueueMessageæ–¹æ³•</span><br>     <span class="hljs-keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çŸ¥é“Handlerçš„<code>post</code>å’Œ<code>send</code>ç³»åˆ—æ–¹æ³•å‘é€çš„æ¶ˆæ¯ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œmsg.targetéƒ½ä¼šè¢«èµ‹å€¼ï¼Œå› æ­¤ä¸å¯èƒ½ä¸ºç©ºã€‚é‚£msg.targetå•¥æ—¶å€™ä¼šä¸ºç©ºå‘¢ï¼Ÿæˆ‘ä»¬æ¨æ–­è‚¯å®šæ˜¯å…¶ä»–å‘é€æ¶ˆæ¯çš„æ–¹æ³•ä½¿å¾—msg.targetä¸ºç©ºï¼Œé‚£æˆ‘ä»¬å°±æ‰¾ä¸€ä¸‹ï¼Œä¼šå‘ç°MessageQueueçš„<code>postSyncBarrier</code>çš„æ–¹æ³•ä¸­æ²¡æœ‰ç»™msg.targetå¯¹è±¡èµ‹å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">postSyncBarrier</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> postSyncBarrier(SystemClock.uptimeMillis());<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">postSyncBarrier</span><span class="hljs-params">(<span class="hljs-type">long</span> when)</span> &#123;<br>     <span class="hljs-comment">// Enqueue a new sync barrier token.</span><br>     <span class="hljs-comment">// We don&#x27;t need to wake the queue because the purpose of a barrier is to stall it.</span><br>     <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>         <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> mNextBarrierToken++;<br>         <span class="hljs-keyword">final</span> <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();<br>         msg.markInUse();<br>         msg.when = when;<br>         msg.arg1 = token;<br><br>         <span class="hljs-type">Message</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>         <span class="hljs-type">Message</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mMessages;<br>         <span class="hljs-keyword">if</span> (when != <span class="hljs-number">0</span>) &#123;<br>             <span class="hljs-keyword">while</span> (p != <span class="hljs-literal">null</span> &amp;&amp; p.when &lt;= when) &#123;<br>                 prev = p;<br>                 p = p.next;<br>             &#125;<br>         &#125;<br>         <span class="hljs-keyword">if</span> (prev != <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// invariant: p == prev.next</span><br>             msg.next = p;<br>             prev.next = msg;<br>         &#125; <span class="hljs-keyword">else</span> &#123;<br>             msg.next = p;<br>             mMessages = msg;<br>         &#125;<br>         <span class="hljs-keyword">return</span> token;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç å°±æ˜¯å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­åˆé€‚çš„ä½ç½®æ’å…¥targetå±æ€§ä¸ºnullçš„Message</p>
<p>å› æ­¤æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥çŸ¥é“ï¼ŒMessageçš„targetå±æ€§ä¸ºç©ºå’Œéç©ºæ˜¯å¾ˆä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œå°±ä¸å–å…³å­äº†ï¼Œç›´æ¥ç»™ç»“è®º: <strong>targetå±æ€§ä¸ºç©ºçš„Messageå°±æ˜¯åŒæ­¥å±éšœï¼Œä»–æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ¶ˆæ¯ï¼Œå¹¶ä¸ä¼šè¢«æ¶ˆè´¹ï¼Œä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªæ ‡è¯†å¤„äº MessageQueue ä¸­ï¼Œå½“MessageQueueçš„<code>next</code>æ–¹æ³•é‡åˆ°åŒæ­¥å±éšœçš„æ—¶å€™ï¼Œå°±ä¼šå¾ªç¯éå†æ•´ä¸ªé“¾è¡¨æ‰¾åˆ°æ ‡è®°ä¸ºå¼‚æ­¥æ¶ˆæ¯çš„Messageï¼Œå…¶ä»–çš„æ¶ˆæ¯ä¼šç›´æ¥å¿½è§†ï¼Œé‚£ä¹ˆè¿™æ ·å¼‚æ­¥æ¶ˆæ¯å°±ä¼šæå‰è¢«æ‰§è¡Œäº†</strong></p>
<p>ç°åœ¨æˆ‘ä»¬ç°åœ¨å°±å¯ä»¥å›ç­”ä¸Šé¢çš„é—®é¢˜äº†ï¼š<strong>targetå±æ€§ä¸ºç©ºçš„Messageå°±æ˜¯åŒæ­¥å±éšœï¼ŒåŒæ­¥å±éšœå¯ä»¥ä½¿å¾—å¼‚æ­¥æ¶ˆæ¯ä¼˜å…ˆè¢«å¤„ç†ï¼Œé€šè¿‡MessageQueueçš„<code>postSyncBarrier</code>å¯ä»¥æ·»åŠ ä¸€ä¸ªåŒæ­¥å±éšœ</strong></p>
<p><strong>æ³¨æ„</strong>: <strong>åœ¨å¼‚æ­¥æ¶ˆæ¯å¤„ç†å®Œä¹‹åï¼ŒåŒæ­¥å±éšœå¹¶ä¸ä¼šè¢«ç§»é™¤ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç§»é™¤ï¼Œä»ä¸Šé¢çš„æºç æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸ç§»é™¤åŒæ­¥å±éšœï¼Œé‚£ä¹ˆä»–ä¼šä¸€ç›´åœ¨é‚£é‡Œï¼Œè¿™æ ·åŒæ­¥æ¶ˆæ¯å°±æ°¸è¿œæ— æ³•è¢«æ‰§è¡Œäº†ã€‚</strong></p>
<p>å› æ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨å®ŒåŒæ­¥å±éšœåï¼Œéœ€è¦æ‰‹åŠ¨ç§»é™¤ï¼Œä»£ç å¦‚ä¸‹: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSyncBarrier</span><span class="hljs-params">(<span class="hljs-type">int</span> token)</span> &#123;<br>     <span class="hljs-comment">// Remove a sync barrier token from the queue.</span><br>     <span class="hljs-comment">// If the queue is no longer stalled by a barrier then wake it.</span><br>     <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>         <span class="hljs-type">Message</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>         <span class="hljs-type">Message</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mMessages;<br>         <span class="hljs-keyword">while</span> (p != <span class="hljs-literal">null</span> &amp;&amp; (p.target != <span class="hljs-literal">null</span> || p.arg1 != token)) &#123;<br>             prev = p;<br>             p = p.next;<br>         &#125;<br>         <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">null</span>) &#123;<br>             <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;The specified message queue synchronization &quot;</span><br>                     + <span class="hljs-string">&quot; barrier token has not been posted or has already been removed.&quot;</span>);<br>         &#125;<br>         <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> needWake;<br>         <span class="hljs-keyword">if</span> (prev != <span class="hljs-literal">null</span>) &#123;<br>             prev.next = p.next;<br>             needWake = <span class="hljs-literal">false</span>;<br>         &#125; <span class="hljs-keyword">else</span> &#123;<br>             mMessages = p.next;<br>             needWake = mMessages == <span class="hljs-literal">null</span> || mMessages.target != <span class="hljs-literal">null</span>;<br>         &#125;<br>         p.recycleUnchecked();<br><br>         <span class="hljs-comment">// If the loop is quitting then it is already awake.</span><br>         <span class="hljs-comment">// We can assume mPtr != 0 when mQuitting is false.</span><br>         <span class="hljs-keyword">if</span> (needWake &amp;&amp; !mQuitting) &#123;<br>             nativeWake(mPtr);<br>         &#125;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘å¿ƒé‡Œåˆæœ‰ä¸€ä¸ªç–‘é—®äº†ï¼Ÿæ€ä¹ˆæŠŠä¸€ä¸ªæ¶ˆæ¯å˜æˆå¼‚æ­¥æ¶ˆæ¯å‘¢ï¼Ÿè¿˜æ˜¯å›åˆ°Handlerçš„<code>enqueueMessage</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">enqueueMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MessageQueue queue, <span class="hljs-meta">@NonNull</span> Message msg,<span class="hljs-type">long</span> uptimeMillis)</span> &#123;<br>     msg.target = <span class="hljs-built_in">this</span>;<br>     msg.workSourceUid = ThreadLocalWorkSource.getUid();<br>     <span class="hljs-comment">//å¦‚æœmAsynchronousï¼Œåˆ™å°†è¯¥æ¶ˆæ¯è®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯</span><br>     <span class="hljs-keyword">if</span> (mAsynchronous) &#123;<br>         msg.setAsynchronous(<span class="hljs-literal">true</span>);<br>     &#125;<br>     <span class="hljs-keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°ä»£ç æˆ‘æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡msg.setAsynchronousæ–¹æ³•è®¾ç½®ä¸ºtrueï¼Œå¯ä»¥æŠŠä¸€ä¸ªæ¶ˆæ¯å˜æˆå¼‚æ­¥æ¶ˆæ¯ï¼Œä½†æ˜¯å‰æå¾—æ»¡è¶³mAsynchronouså±æ€§ä¸ºtrueï¼ŒmAsynchronousæ˜¯Handlerä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œä»–ä¼šåœ¨è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ä¸­è¢«èµ‹å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@UnsupportedAppUsage</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Looper looper, <span class="hljs-meta">@Nullable</span> Callback callback, <span class="hljs-type">boolean</span> async)</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    mAsynchronous = async;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Callback callback, <span class="hljs-type">boolean</span> async)</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    mAsynchronous = async;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å¾—å‡ºç»“è®ºï¼ŒæŠŠä¸€ä¸ªæ¶ˆæ¯è®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>1ã€åœ¨Handlerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¼ å…¥asyncä¸ºtrueï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å‘é€çš„Messageå°±éƒ½æ˜¯å¼‚æ­¥çš„çš„æ¶ˆæ¯</p>
<p>2ã€ç»™Messageé€šè¿‡<code>setAsynchronous</code> æ–¹æ³•æ ‡å¿—ä¸ºå¼‚æ­¥</p>
<p>ä½†æ˜¯ï¼Œä¸Šé¢ä¸¤ä¸ªæ„é€ æ–¹æ³•å¯¹å¤–æ˜¯ä¸å¯è§çš„ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸åˆ°ï¼Œè€Œä¸”è®¾ç½®åŒæ­¥å±éšœçš„æ–¹æ³•å¯¹å¤–ä¹Ÿæ˜¯ä¸å¯è§çš„ï¼Œè¯´æ˜è°·æ­Œä¸æƒ³è¦æˆ‘ä»¬å»ä½¿ç”¨ä»–ã€‚æ‰€ä»¥è¿™é‡ŒåŒæ­¥å±éšœä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªäº†è§£ï¼Œä¸€èˆ¬åªæœ‰ç³»ç»Ÿä¼šå»ä½¿ç”¨å®ƒï¼Œä¾‹å¦‚ï¼šåœ¨è¿›è¡ŒUIç»˜åˆ¶çš„æ—¶å€™ï¼Œä»¥ä¸‹æ˜¯ViewRootImplä¸­æ‰§è¡ŒUIç»˜åˆ¶çš„æ–¹æ³•ä½¿ç”¨åˆ°äº†åŒæ­¥å±éšœ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@UnsupportedAppUsage</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!mTraversalScheduled) &#123;<br>        mTraversalScheduled = <span class="hljs-literal">true</span>;<br>        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();<br>        mChoreographer.postCallback(<br>                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (!mUnbufferedInputDispatch) &#123;<br>            scheduleConsumeBatchedInput();<br>        &#125;<br>        notifyRendererOfFramePending();<br>        pokeDrawLockIfNeeded();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">unscheduleTraversals</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (mTraversalScheduled) &#123;<br>        mTraversalScheduled = <span class="hljs-literal">false</span>;<br>        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);<br>        mChoreographer.removeCallbacks(<br>                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç åœ¨æŠŠç»˜åˆ¶æ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ä¹‹å‰ï¼Œå…ˆæ”¾å…¥äº†ä¸€ä¸ªåŒæ­¥å±éšœï¼Œç„¶ååœ¨å‘é€å¼‚æ­¥ç»˜åˆ¶æ¶ˆæ¯ï¼Œä»è€Œä½¿å¾—ç•Œé¢ç»˜åˆ¶çš„æ¶ˆæ¯ä¼šæ¯”å…¶ä»–æ¶ˆæ¯ä¼˜å…ˆæ‰§è¡Œï¼Œé¿å…äº†å› ä¸º MessageQueue ä¸­æ¶ˆæ¯å¤ªå¤šå¯¼è‡´ç»˜åˆ¶æ¶ˆæ¯è¢«é˜»å¡å¯¼è‡´ç”»é¢å¡é¡¿ï¼Œå½“ç»˜åˆ¶å®Œæˆåï¼Œå°±ä¼šå°†åŒæ­¥å±éšœç§»é™¤ã€‚</p>
<h2 id="IdleHandler"><a href="#IdleHandler" class="headerlink" title="IdleHandler"></a>IdleHandler</h2><p>è§åçŸ¥æ„ï¼Œidleæ˜¯ç©ºé—²çš„æ„æ€ï¼Œé‚£ä¹ˆIdleHandlerå°±æ˜¯ç©ºé—²çš„Handlerï¼Œæœ‰ç‚¹è¿™ä¸ªæ„æ€ï¼Œå®é™…ä¸Šå®ƒæ˜¯MessageQueueä¸­æœ‰ä¸€ä¸ªé™æ€æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IdleHandler</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">queueIdle</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªå•æ–¹æ³•çš„æ¥å£ï¼Œä¹Ÿå¯ç§°ä¸ºå‡½æ•°å‹æ¥å£ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š<strong>åœ¨UIçº¿ç¨‹å¤„ç†å®Œæ‰€æœ‰Viewäº‹åŠ¡åï¼Œå›è°ƒä¸€äº›é¢å¤–çš„æ“ä½œï¼Œä¸”ä¸ä¼šå µå¡ä¸»è¿›ç¨‹ï¼›</strong>æˆ‘ä»¬æ¥å®é™…æ“ä½œä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>().getLooper().getQueue().addIdleHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>.IdleHandler() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">queueIdle</span><span class="hljs-params">()</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;queueIdle: ç©ºé—²æ—¶åšä¸€äº›è½»é‡çº§åˆ«&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//ä¸Šé¢ä»£ç ä¼šæ‰“å°å¦‚ä¸‹ç»“æœ</span><br>queueIdle: ç©ºé—²æ—¶åšä¸€äº›è½»é‡çº§åˆ«<br></code></pre></td></tr></table></figure>

<p>æ¥ç€è¿›è¡Œæºç åˆ†æï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸‹<code>addIdleHandler</code>è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addIdleHandler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IdleHandler handler)</span> &#123;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;Can&#x27;t add a null IdleHandler&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        mIdleHandlers.add(handler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¢«æ·»åŠ è¿›æ¥çš„handleræ”¾åˆ°äº†mIdleHandlersï¼Œè·Ÿè¿‡å»çœ‹ä¸‹mIdleHandlersï¼Œä¼šå‘ç°MessageQueueä¸­å®šä¹‰äº†IdleHandlerçš„é›†åˆå’Œæ•°ç»„ï¼Œå¹¶ä¸”æœ‰ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;IdleHandler&gt; mIdleHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;IdleHandler&gt;();<br><span class="hljs-keyword">private</span> IdleHandler[] mPendingIdleHandlers;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addIdleHandler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IdleHandler handler)</span> &#123;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;Can&#x27;t add a null IdleHandler&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        mIdleHandlers.add(handler);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeIdleHandler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IdleHandler handler)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        mIdleHandlers.remove(handler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€ååœ¨çœ‹ä¸‹MessageQueueä¸­çš„<code>Next</code>æ–¹æ³•ï¼Œä»…è´´å‡ºå…³é”®ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>  	<span class="hljs-type">int</span> <span class="hljs-variable">pendingIdleHandlerCount</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// -1 only during first iteration</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>             <span class="hljs-comment">//...</span><br>             <span class="hljs-comment">//å½“å‰æ— æ¶ˆæ¯ï¼Œæˆ–è¿˜éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ¶ˆæ¯æ‰èƒ½åˆ†å‘ï¼Œè·å¾—IdleHandlerçš„æ•°é‡</span><br>             <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt; <span class="hljs-number">0</span> &amp;&amp; (mMessages == <span class="hljs-literal">null</span> || now &lt; mMessages.when)) &#123;<br>                 pendingIdleHandlerCount = mIdleHandlers.size();<br>             &#125;<br>          <br>          	 <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="hljs-number">0</span>) &#123;<br>                 <span class="hljs-comment">// No idle handlers to run.  Loop and wait some more.</span><br>               	 <span class="hljs-comment">//å¦‚æœæ²¡æœ‰idle handleréœ€è¦æ‰§è¡Œï¼Œé˜»å¡çº¿ç¨‹è¿›å…¥ä¸‹æ¬¡å¾ªç¯</span><br>                 mBlocked = <span class="hljs-literal">true</span>;<br>                 <span class="hljs-keyword">continue</span>;<br>             &#125;<br>	     <span class="hljs-comment">//åˆå§‹åŒ–mPendingIdleHandlers</span><br>             <span class="hljs-keyword">if</span> (mPendingIdleHandlers == <span class="hljs-literal">null</span>) &#123;<br>                 mPendingIdleHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class="hljs-number">4</span>)];<br>             &#125;<br>             <span class="hljs-comment">//æŠŠListè½¬åŒ–æˆæ•°ç»„ç±»å‹</span><br>             mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);<br>         &#125;<br>      <br>        <span class="hljs-comment">//å¾ªç¯éå†æ‰€æœ‰çš„IdleHandler</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">IdleHandler</span> <span class="hljs-variable">idler</span> <span class="hljs-operator">=</span> mPendingIdleHandlers[i];<br>            mPendingIdleHandlers[i] = <span class="hljs-literal">null</span>; <span class="hljs-comment">// release the reference to the handler</span><br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">keep</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>              	<span class="hljs-comment">//è·å¾—idler.queueIdleçš„è¿”å›å€¼</span><br>                keep = idler.queueIdle();<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                Log.wtf(TAG, <span class="hljs-string">&quot;IdleHandler threw exception&quot;</span>, t);<br>            &#125;<br>            <span class="hljs-comment">//keepå³idler.queueIdleçš„è¿”å›å€¼ï¼Œå¦‚æœä¸ºfalseè¡¨æ˜åªè¦æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ç§»é™¤ï¼Œå¦åˆ™ä¸ç§»é™¤</span><br>            <span class="hljs-keyword">if</span> (!keep) &#123;<br>                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                    mIdleHandlers.remove(idler);<br>                &#125;<br>            &#125;<br>         &#125;<br>         <span class="hljs-comment">// Reset the idle handler count to 0 so we do not run them again.</span><br>      	 <span class="hljs-comment">//å°†pendingIdleHandlerCountç½®ä¸º0é¿å…ä¸‹æ¬¡å†æ¬¡æ‰§è¡Œ</span><br>         pendingIdleHandlerCount = <span class="hljs-number">0</span>;<br>      <br>      	 <span class="hljs-comment">// å½“åœ¨æ‰§è¡ŒIdleHandlerçš„æ—¶å€™ï¼Œå¯èƒ½æœ‰æ–°çš„æ¶ˆæ¯å·²ç»è¿›æ¥äº†</span><br>         <span class="hljs-comment">// æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸èƒ½é˜»å¡ï¼Œè¦å›å»å¾ªç¯ä¸€æ¬¡çœ‹ä¸€ä¸‹</span><br>         nextPollTimeoutMillis = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç è§£æï¼š</p>
<p>1ã€å½“è°ƒç”¨nextæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå°†pendingIdleHandlerCountèµ‹å€¼ä¸º-1</p>
<p>2ã€åˆ¤æ–­pendingIdleHandlerCountæ˜¯å¦å°äº0å¹¶ä¸”MessageQueue æ˜¯å¦ä¸ºç©ºæˆ–è€…æœ‰å»¶è¿Ÿæ¶ˆæ¯éœ€è¦æ‰§è¡Œï¼Œå¦‚æœæ˜¯åˆ™æŠŠå­˜å‚¨IdleHandlerçš„listçš„é•¿åº¦èµ‹å€¼ç»™pendingIdleHandlerCount</p>
<p>3ã€åˆ¤æ–­å¦‚æœæ²¡æœ‰IdleHandleréœ€è¦æ‰§è¡Œï¼Œé˜»å¡çº¿ç¨‹è¿›å…¥ä¸‹æ¬¡å¾ªç¯ï¼Œå¦‚æœæœ‰ï¼Œåˆ™åˆå§‹åŒ–mPendingIdleHandlersï¼ŒæŠŠlistä¸­çš„æ‰€æœ‰IdleHandleræ”¾åˆ°æ•°ç»„ä¸­ã€‚è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ä¸è®©åœ¨æ‰§è¡ŒIdleHandlerçš„æ—¶å€™Listè¢«æ’å…¥æ–°çš„IdleHandlerï¼Œé€ æˆé€»è¾‘æ··ä¹±</p>
<p>4ã€å¾ªç¯éå†æ‰€æœ‰çš„IdleHandlerå¹¶æ‰§è¡Œï¼ŒæŸ¥çœ‹idler.queueIdleæ–¹æ³•çš„è¿”å›å€¼ï¼Œä¸ºfalseè¡¨æ˜è¿™ä¸ªIdleHandleråªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ç§»é™¤ï¼Œä¸ºtrueï¼Œåˆ™ä¸ç§»é™¤</p>
<p>5ã€å°†pendingIdleHandlerCountç½®ä¸º0é¿å…ä¸‹æ¬¡å†æ¬¡æ‰§è¡Œï¼Œ å½“åœ¨æ‰§è¡ŒIdleHandlerçš„æ—¶å€™ï¼Œå¯èƒ½æœ‰æ–°çš„æ¶ˆæ¯å·²ç»è¿›æ¥äº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸èƒ½é˜»å¡ï¼Œè¦å›å»å¾ªç¯ä¸€æ¬¡çœ‹ä¸€ä¸‹</p>
<p>åˆ°è¿™é‡ŒåŒæ­¥å±éšœå’ŒIdleHandleréƒ½è®²å®Œäº†ï¼Œå»ºè®®è¯»è€…é…åˆå®Œæ•´çš„æºç åœ¨å»ä»”ç»†é˜…è¯»ä¸€æ¬¡ã€‚</p>
<p><strong>å®é™…åº”ç”¨</strong>: å¯ä»¥åœ¨IdleHandleré‡Œé¢è·å–Viewçš„å®½é«˜</p>
<h2 id="ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯"><a href="#ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯" class="headerlink" title="ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯"></a>ä¸»çº¿ç¨‹æ¶ˆæ¯å¾ªç¯</h2><p>åœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬è®²åˆ°ï¼ŒActivityThreadå°±æ˜¯ä¸»çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯UIçº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹çš„<code>mainæ–¹æ³•ä¸­</code>åˆ›å»ºäº†Looperï¼Œå¹¶å¼€å¯äº†æ¶ˆæ¯å¾ªç¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-comment">//åˆ›å»ºLooper</span><br>  Looper.prepareMainLooper();<br>  <br>  <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br>  thread.attach(<span class="hljs-literal">false</span>);<br><br>  <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) &#123;<br>    sMainThreadHandler = thread.getHandler();<br>  &#125;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-comment">//å¼€å¯å¾ªç¯è¯»å–æ¶ˆæ¯</span><br>  Looper.loop();<br>  <span class="hljs-comment">//Looperå¦‚æœå› å¼‚å¸¸åŸå› åœæ­¢å¾ªç¯åˆ™æŠ›å¼‚å¸¸</span><br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯å¼€å§‹äº†ä»¥åï¼ŒActivityThreadè¿˜éœ€è¦æœ‰ä¸€ä¸ªHandleræ¥å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œäº¤äº’ï¼Œè¿™ä¸ªHandlerå°±æ˜¯ActivityThread.Hï¼Œå®ƒå†…éƒ¨å®šä¹‰äº†å¾ˆå¤šçš„æ¶ˆæ¯ç±»å‹ï¼Œä¾‹å¦‚å››å¤§ç»„ä»¶çš„å¯åŠ¨ï¼ŒApplicationçš„å¯åŠ¨ç­‰ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BIND_APPLICATION</span>        <span class="hljs-operator">=</span> <span class="hljs-number">110</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXIT_APPLICATION</span>        <span class="hljs-operator">=</span> <span class="hljs-number">111</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">RECEIVER</span>                <span class="hljs-operator">=</span> <span class="hljs-number">113</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CREATE_SERVICE</span>          <span class="hljs-operator">=</span> <span class="hljs-number">114</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SERVICE_ARGS</span>            <span class="hljs-operator">=</span> <span class="hljs-number">115</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">STOP_SERVICE</span>            <span class="hljs-operator">=</span> <span class="hljs-number">116</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONFIGURATION_CHANGED</span>   <span class="hljs-operator">=</span> <span class="hljs-number">118</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CLEAN_UP_CONTEXT</span>        <span class="hljs-operator">=</span> <span class="hljs-number">119</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GC_WHEN_IDLE</span>            <span class="hljs-operator">=</span> <span class="hljs-number">120</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BIND_SERVICE</span>            <span class="hljs-operator">=</span> <span class="hljs-number">121</span>;<br>        <span class="hljs-meta">@UnsupportedAppUsage</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">UNBIND_SERVICE</span>          <span class="hljs-operator">=</span> <span class="hljs-number">122</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DUMP_SERVICE</span>            <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LOW_MEMORY</span>              <span class="hljs-operator">=</span> <span class="hljs-number">124</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROFILER_CONTROL</span>        <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CREATE_BACKUP_AGENT</span>     <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DESTROY_BACKUP_AGENT</span>    <span class="hljs-operator">=</span> <span class="hljs-number">129</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUICIDE</span>                 <span class="hljs-operator">=</span> <span class="hljs-number">130</span>;<br>     		<span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> &#123;<br>          	<span class="hljs-comment">//...</span><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…³äºActivityThread.Hçš„å®é™…åº”ç”¨ï¼Œæˆ‘ä»¬åœ¨çœ‹<a target="_blank" rel="noopener" href="https://juejin.cn/post/6847902222294990862">Activityçš„å¯åŠ¨æµç¨‹</a>å¯èƒ½ä¼šæœ‰æ¯”è¾ƒæ·±å…¥çš„ç†è§£ï¼ŒActivityThreadé€šè¿‡ApplicationThreadå’ŒAMSè¿›è¡Œè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼å®ŒæˆActivityThreadçš„è¯·æ±‚åï¼Œä¼šå›è°ƒApplicationThreadä¸­çš„Binderæ–¹æ³•ï¼Œç„¶åApplicationThreadä¼šå‘Hå‘é€æ¶ˆæ¯ï¼ŒHæ”¶åˆ°æ¶ˆæ¯åä¼šå°†ApplicationThreadä¸­çš„é€»è¾‘åˆ‡æ¢åˆ°ActivityThreadä¸­å»æ‰§è¡Œï¼Œå³åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹å»æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æ¨¡å‹</p>
<h2 id="å¦™ç”¨-Looper-æœºåˆ¶"><a href="#å¦™ç”¨-Looper-æœºåˆ¶" class="headerlink" title="å¦™ç”¨ Looper æœºåˆ¶"></a>å¦™ç”¨ Looper æœºåˆ¶</h2><p>1ã€æˆ‘ä»¬å¯ä»¥é€šè¿‡Looper<code>getMainLooper</code>æ–¹æ³•è·å–ä¸»çº¿ç¨‹Looperï¼Œä»è€Œå¯ä»¥åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹</p>
<p>2ã€å°† Runnable post åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainThread</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MainThread</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">HANDLER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper());<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Runnable runnable)</span> &#123;<br>        <span class="hljs-keyword">if</span> (isMainThread()) &#123;<br>            runnable.run();<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            HANDLER.post(runnable);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isMainThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Looper.myLooper() == Looper.getMainLooper();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å­çº¿ç¨‹ä½¿ç”¨HandleråŠç›¸å…³æ³¨æ„äº‹é¡¹"><a href="#å­çº¿ç¨‹ä½¿ç”¨HandleråŠç›¸å…³æ³¨æ„äº‹é¡¹" class="headerlink" title="å­çº¿ç¨‹ä½¿ç”¨HandleråŠç›¸å…³æ³¨æ„äº‹é¡¹"></a>å­çº¿ç¨‹ä½¿ç”¨HandleråŠç›¸å…³æ³¨æ„äº‹é¡¹</h2><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨Handleréƒ½æ˜¯ä»å­çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹å»å¤„ç†ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹ä»ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ°å­çº¿ç¨‹æ¥å¤„ç†ï¼Œä¸Šä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹å®ä¾‹å¹¶å¼€å¯</span><br>        <span class="hljs-type">MyThread</span> <span class="hljs-variable">myThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyThread</span>();<br>        myThread.start();<br>        <span class="hljs-comment">//æ‰“å¼€è¿™æ®µæ³¨é‡Šå°±ä¸ä¼šcrashï¼Œä¸”çœ‹ä¸‹é¢åˆ†æ</span><br><span class="hljs-comment">//      try &#123;</span><br><span class="hljs-comment">//          Thread.sleep(500);</span><br><span class="hljs-comment">//      &#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">//          e.printStackTrace();</span><br><span class="hljs-comment">//      &#125;</span><br>        <span class="hljs-comment">//è·å–Handlerå‘é€æ¶ˆæ¯</span><br>        myThread.getHandler().sendEmptyMessage(<span class="hljs-number">0x001</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>        <span class="hljs-keyword">private</span> Handler mHandler;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            Looper.prepare();<br>            mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() &#123;<br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>                    <span class="hljs-keyword">if</span>(msg.what == <span class="hljs-number">0x001</span>)&#123;<br>                        Log.d(<span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;handleMessage: &quot;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;;<br>            Looper.loop();<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Handler <span class="hljs-title function_">getHandler</span><span class="hljs-params">()</span>&#123;<br>            <span class="hljs-keyword">return</span> mHandler;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œä¸€ä¸‹ä¸Šè¿°ä»£ç ï¼Œå‘ç°ä¼šCrashï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79f6a7b7e65d4c1ea07ea76b3ac49689~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload alt="image-20210223112129732"></p>
<p>æŠ¥äº†ä¸€ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ŒåŸå› å°±æ˜¯å¤šçº¿ç¨‹å¹¶å‘ï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œåˆ°sendEnptyMessageæ—¶ï¼Œå­çº¿ç¨‹çš„Handlerè¿˜æ²¡æœ‰åˆ›å»ºã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è·å–Handlerçš„æ—¶å€™è®©ä¸»çº¿ç¨‹ä¼‘çœ ä¸€ä¸‹åœ¨æ‰§è¡Œï¼Œåº”ç”¨å°±ä¸ä¼šCrashäº†ï¼Œæ‰“å¼€ä¸Šé¢ä»£ç çš„æ³¨é‡Šå³å¯</p>
<p><strong>å€¼å¾—æ³¨æ„çš„æ˜¯</strong>ï¼šæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„Looperåœ¨ä½¿ç”¨å®Œæ¯•ååº”è¯¥è°ƒç”¨<code>quit</code>æ–¹æ³•æ¥ç»ˆæ­¢æ¶ˆæ¯å¾ªç¯ï¼Œå¦‚æœä¸é€€å‡ºçš„è¯ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹çš„Looperå¤„ç†å®Œæ‰€æœ‰çš„æ¶ˆæ¯åï¼Œå°±ä¼šå¤„äºä¸€ä¸ªé˜»å¡çŠ¶æ€ï¼Œè¦çŸ¥é“çº¿ç¨‹æ˜¯æ¯”è¾ƒé‡é‡çº§çš„ï¼Œå¦‚æœä¸€ç›´å­˜åœ¨ï¼Œè‚¯å®šä¼šå¯¹åº”ç”¨æ€§èƒ½é€ æˆä¸€å®šçš„å½±å“ã€‚è€Œå¦‚æœé€€å‡ºLooperï¼Œè¿™ä¸ªçº¿ç¨‹å°±ä¼šç«‹åˆ»ç»ˆæ­¢ï¼Œå› æ­¤å»ºè®®ä¸éœ€è¦çš„æ—¶å€™ç»ˆæ­¢Looperã€‚</p>
<p>å› æ­¤åœ¨å­çº¿ç¨‹ä½¿ç”¨Handlerï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸‹ä¸¤ç‚¹ï¼š</p>
<p><strong>1ã€å¿…é¡»è°ƒç”¨<code> Looper.prepare()</code>åˆ›å»ºå½“å‰çº¿ç¨‹çš„ Looperï¼Œå¹¶è°ƒç”¨<code>Looper.loop()</code>å¼€å¯æ¶ˆæ¯å¾ªç¯</strong></p>
<p><strong>2ã€å¿…é¡»åœ¨ä½¿ç”¨ç»“æŸåè°ƒç”¨Looperçš„<code>quit</code>æ–¹æ³•é€€å‡ºå½“å‰çº¿ç¨‹</strong></p>
<h2 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h2><p>ä¸Šé¢è®²åˆ°ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ°å­çº¿ç¨‹æ¥å¤„ç†ï¼Œå…¶å®Androidå·²ç»ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè¿™æ ·è½»é‡çº§çš„å¼‚æ­¥ç±»ï¼Œé‚£å°±æ˜¯HandlerThread</p>
<p>HandlerThreadçš„å®ç°åŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼š<strong>ç»§æ‰¿Threadå¹¶å¯¹Looperè¿›è¡Œäº†å°è£…</strong></p>
<p>å…·ä½“æºç å°±ä¸è¿‡å¤šåˆ†æäº†ï¼Œå¤§å®¶æœ‰å…´è¶£çš„å¯ä»¥å»çœ‹ä¸€ä¸‹ï¼Œä¹Ÿå°±100å¤šè¡Œä»£ç ï¼Œè¿™é‡Œä¸»è¦è®²è§£ä¸€ä¸‹ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>      	<span class="hljs-comment">//1ï¼Œåˆ›å»ºHandlerå®ä¾‹</span><br>      	<span class="hljs-type">HandlerThread</span> <span class="hljs-variable">mHandlerThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">&quot;HandlerThread&quot;</span>);<br>      	<span class="hljs-comment">//2ï¼Œå¯åŠ¨çº¿ç¨‹</span><br>        mHandlerThread.start();<br>      	<span class="hljs-comment">//3ï¼Œä½¿ç”¨ä¼ å…¥Looperä¸ºå‚æ•°çš„æ„é€ æ–¹æ³•åˆ›å»ºHandlerå®ä¾‹</span><br>        <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(mHandlerThread.getLooper())&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;print&quot;</span>, <span class="hljs-string">&quot;å½“å‰çº¿ç¨‹: &quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot; handleMessage&quot;</span>);<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//4ï¼Œä½¿ç”¨Handlerå‘é€æ¶ˆæ¯</span><br>        mHandler.sendEmptyMessage(<span class="hljs-number">0x001</span>);<br>      	<span class="hljs-comment">//5ï¼Œåœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨HandlerThreadçš„quitæ–¹æ³•ï¼Œé€€å‡ºæ¶ˆæ¯å¾ªç¯</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//ä¸Šè¿°ä»£ç æ‰“å°ç»“æœ:</span><br>å½“å‰çº¿ç¨‹: HandlerThread handleMessage<br></code></pre></td></tr></table></figure>

<h3 id="Handler-HandlerThread-Threadä¸‰è€…åŒºåˆ«"><a href="#Handler-HandlerThread-Threadä¸‰è€…åŒºåˆ«" class="headerlink" title="Handler  HandlerThread  Threadä¸‰è€…åŒºåˆ«"></a>Handler  HandlerThread  Threadä¸‰è€…åŒºåˆ«</h3><p><strong>Handler</strong>ï¼šåœ¨Androidä¸­è´Ÿè´£å‘é€å’Œå¤„ç†æ¶ˆæ¯</p>
<p><strong>HandlerThread</strong>ï¼šç»§æ‰¿è‡ªThreadï¼Œå¯¹Looperè¿›è¡Œäº†å°è£…ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåœ¨å­çº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªLooperï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­å»å¤„ç†æ¶ˆæ¯</p>
<p><strong>Thread</strong>: cpuæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œå³çº¿ç¨‹ï¼Œå®ƒåœ¨æ‰§è¡Œå®Œåå°±ç«‹é©¬ç»“æŸäº†ï¼Œå¹¶ä¸èƒ½å»å¤„ç†æ¶ˆæ¯ã€‚å¦‚æœè¦å¤„ç†ï¼Œéœ€è¦é…åˆLooperï¼ŒHandlerä¸€èµ·ä½¿ç”¨</p>
<h2 id="å­çº¿ç¨‹å¼¹Toast"><a href="#å­çº¿ç¨‹å¼¹Toast" class="headerlink" title="å­çº¿ç¨‹å¼¹Toast"></a>å­çº¿ç¨‹å¼¹Toast</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å­çº¿ç¨‹å¼¹Toast&quot;</span>, Toast.LENGTH_SHORT).show();<br>    &#125;<br>&#125;.start();<br><br><span class="hljs-comment">//2</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        Looper.prepare();<br>        Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;å­çº¿ç¨‹å¼¹Toast&quot;</span>, Toast.LENGTH_SHORT).show();<br>        Looper.loop();<br>    &#125;<br>&#125;.start();<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°1ä»£ç è¿è¡Œä¼šå¥”æºƒï¼Œä¼šæŠ¥è¿™ä¹ˆä¸€ä¸ªå¼‚å¸¸æç¤ºï¼š**â€Canâ€™t toast on a thread that has not called Looper.prepare()â€**</p>
<p>åŸå› å°±æ˜¯Toastçš„å®ç°ä¹Ÿæ˜¯ä¾èµ–Handlerï¼Œè€Œæˆ‘ä»¬çŸ¥é“åœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºHandlerï¼Œéœ€å…ˆåˆ›å»ºLooperå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œè¿™ç‚¹åœ¨Toastä¸­çš„æºç ä¹Ÿæœ‰ä½“ç°ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4fb7b199888404f864e1d0c43d0dc7f~tplv-k3u1fbpfcp-zoom-1.image" srcset="/img/loading.gif" lazyload alt="image-20210223131023498"></p>
<p>å› æ­¤æˆ‘ä»¬åœ¨å­çº¿ç¨‹åˆ›å»ºToastå°±éœ€è¦ä½¿ç”¨ä¸Šè¿°2ä»£ç çš„æ–¹å¼</p>
<h2 id="å­çº¿ç¨‹å¼¹Dialog"><a href="#å­çº¿ç¨‹å¼¹Dialog" class="headerlink" title="å­çº¿ç¨‹å¼¹Dialog"></a>å­çº¿ç¨‹å¼¹Dialog</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;<br>    <span class="hljs-meta">@Override</span><br>  	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            Looper.prepare();<br>      	    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(MainActivity.<span class="hljs-built_in">this</span>)<br>                  .setTitle(<span class="hljs-string">&quot;æ ‡é¢˜&quot;</span>)<br>                  .setMessage(<span class="hljs-string">&quot;å­çº¿ç¨‹å¼¹Dialog&quot;</span>)<br>                  .setNegativeButton(<span class="hljs-string">&quot;å–æ¶ˆ&quot;</span>,<span class="hljs-literal">null</span>)<br>                  .setPositiveButton(<span class="hljs-string">&quot;ç¡®å®š&quot;</span>,<span class="hljs-literal">null</span>)<br>                  .show();<br>            Looper.loop();     <br>    &#125;    <br>&#125;.start();<br></code></pre></td></tr></table></figure>

<p>å’Œä¸Šé¢Toastå·®ä¸å¤šï¼Œè¿™é‡Œè´´å‡ºæ­£ç¡®çš„ä»£ç ç¤ºä¾‹ï¼Œå®ƒçš„å®ç°ä¹Ÿæ˜¯ä¾èµ–Handlerï¼Œæˆ‘ä»¬åœ¨å®ƒçš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>();<br></code></pre></td></tr></table></figure>

<p>ä»–ç›´æ¥å°±newäº†ä¸€ä¸ªHandlerå®ä¾‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºHandlerï¼Œéœ€è¦å…ˆåˆ›å»ºLooperå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œä¸»çº¿ç¨‹ä¸­å·²ç»ç»™æˆ‘ä»¬åˆ›å»ºå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯ï¼Œè€Œå­çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰ï¼Œå¦‚æœä¸åˆ›å»ºé‚£å°±ä¼šæŠ¥è¿™å¥ç»å…¸çš„å¼‚å¸¸æç¤ºï¼š**â€Canâ€™t create handler inside thread that has not called Looper.prepare() â€œ**ï¼Œå› æ­¤åœ¨å­çº¿ç¨‹ä¸­ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯</p>
<p>åˆ°è¿™é‡Œï¼ŒHandlerç›¸å…³çš„æ‰©å±•çŸ¥è¯†å°±å…¨éƒ¨è®²å®Œäº†ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¹Ÿæœ‰ç€å¾ˆå¤šä½¿ç”¨çš„å°æŠ€å·§ï¼Œæ¯”å¦‚ IdleHandlerï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ç­‰ç­‰</p>
<p>ç”±äº Handler çš„ç‰¹æ€§ï¼Œå®ƒåœ¨ Android é‡Œçš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚ï¼š AsyncTaskã€HandlerThreadã€Messengerã€IdleHandler å’Œ IntentService ç­‰ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å›ç­”ä¸Šä¸€ç¯‡ä¸­åˆ—å‡ºæ¥çš„ä¸€ç³»åˆ—é—®é¢˜</p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="1ã€Handleræœ‰å“ªäº›ä½œç”¨"><a href="#1ã€Handleræœ‰å“ªäº›ä½œç”¨" class="headerlink" title="1ã€Handleræœ‰å“ªäº›ä½œç”¨?"></a>1ã€Handleræœ‰å“ªäº›ä½œç”¨?</h3><p>ç­”ï¼š</p>
<p> 1ã€Handlerèƒ½å¤Ÿè¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ </p>
<p>2ã€Handlerèƒ½å¤ŸæŒ‰ç…§é¡ºåºå¤„ç†æ¶ˆæ¯ï¼Œé¿å…å¹¶å‘ </p>
<p>3ã€Handlerèƒ½å¤Ÿé˜»å¡çº¿ç¨‹ </p>
<p>4ã€Handlerèƒ½å¤Ÿå‘é€å¹¶å¤„ç†å»¶è¿Ÿæ¶ˆæ¯</p>
<p>è§£æ: </p>
<p>1ã€Handlerèƒ½å¤Ÿè¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œæ˜¯å› ä¸ºä½¿ç”¨äº†ä¸åŒçº¿ç¨‹çš„Looperå¤„ç†æ¶ˆæ¯</p>
<p>2ã€Handlerèƒ½å¤ŸæŒ‰ç…§é¡ºåºå¤„ç†æ¶ˆæ¯ï¼Œé¿å…å¹¶å‘ï¼Œæ˜¯å› ä¸ºæ¶ˆæ¯åœ¨å…¥é˜Ÿçš„æ—¶å€™ä¼šæŒ‰ç…§æ—¶é—´å‡åºå¯¹å½“å‰é“¾è¡¨è¿›è¡Œæ’åºï¼ŒLooperè¯»å–çš„æ—¶å€™ï¼ŒMessageQueueçš„<code>next</code>æ–¹æ³•ä¼šå¾ªç¯åŠ é”ï¼ŒåŒæ—¶é…åˆé˜»å¡å”¤é†’æœºåˆ¶</p>
<p>3ã€Handlerèƒ½å¤Ÿé˜»å¡çº¿ç¨‹ä¸»è¦æ˜¯åŸºäºLinuxçš„epollæœºåˆ¶å®ç°çš„</p>
<p>4ã€Handlerèƒ½å¤Ÿå¤„ç†å»¶è¿Ÿæ¶ˆæ¯ï¼Œæ˜¯å› ä¸ºMessageQueueçš„<code>next</code>æ–¹æ³•ä¸­ä¼šæ‹¿å½“å‰æ¶ˆæ¯æ—¶é—´å’Œå½“å‰æ—¶é—´åšæ¯”è¾ƒï¼Œå¦‚æœæ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰é˜»å¡æ—¶é—´åˆ°ï¼Œåœ¨æ‰§è¡Œè¯¥æ¶ˆæ¯</p>
<h3 id="2ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»ºLooperï¼Ÿ"><a href="#2ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»ºLooperï¼Ÿ" class="headerlink" title="2ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»ºLooperï¼Ÿ"></a>2ã€ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»çº¿ç¨‹ç›´æ¥ä½¿ç”¨Handlerï¼Œè€Œä¸éœ€è¦åˆ›å»ºLooperï¼Ÿ</h3><p>ç­”ï¼šä¸»çº¿ç¨‹å·²ç»åˆ›å»ºäº†Looperï¼Œå¹¶å¼€å¯äº†æ¶ˆæ¯å¾ªç¯</p>
<h3 id="3ã€å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œéœ€è¦åšä»€ä¹ˆå‡†å¤‡ï¼Ÿ"><a href="#3ã€å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œéœ€è¦åšä»€ä¹ˆå‡†å¤‡ï¼Ÿ" class="headerlink" title="3ã€å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œéœ€è¦åšä»€ä¹ˆå‡†å¤‡ï¼Ÿ"></a>3ã€å¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹åˆ›å»ºHandlerï¼Œéœ€è¦åšä»€ä¹ˆå‡†å¤‡ï¼Ÿ</h3><p>ç­”ï¼šéœ€è¦å…ˆåˆ›å»ºLooperï¼Œå¹¶å¼€å¯æ¶ˆæ¯å¾ªç¯</p>
<h3 id="4ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ"><a href="#4ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ" class="headerlink" title="4ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ"></a>4ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ</h3><p>ç­”ï¼šå¯ä»¥æœ‰ä»»æ„å¤šä¸ª</p>
<h3 id="5ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªLooperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#5ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªLooperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="5ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªLooperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ"></a>5ã€ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªLooperï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ</h3><p>ç­”ï¼šä¸€ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªLooperï¼Œé€šè¿‡ThreadLocalæ¥ä¿è¯</p>
<h3 id="6ã€Handlerå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ—¶é—´ä¸ºå•¥è¦å–SystemClock-uptimeMillis-delayMillisï¼Œå¯ä»¥æŠŠSystemClock-uptimeMillis-æ¢æˆSystem-currentTimeMillis-å—ï¼Ÿ"><a href="#6ã€Handlerå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ—¶é—´ä¸ºå•¥è¦å–SystemClock-uptimeMillis-delayMillisï¼Œå¯ä»¥æŠŠSystemClock-uptimeMillis-æ¢æˆSystem-currentTimeMillis-å—ï¼Ÿ" class="headerlink" title="6ã€Handlerå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ—¶é—´ä¸ºå•¥è¦å–SystemClock.uptimeMillis() + delayMillisï¼Œå¯ä»¥æŠŠSystemClock.uptimeMillis() æ¢æˆSystem.currentTimeMillis()å—ï¼Ÿ"></a>6ã€Handlerå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ—¶é—´ä¸ºå•¥è¦å–SystemClock.uptimeMillis() + delayMillisï¼Œå¯ä»¥æŠŠSystemClock.uptimeMillis() æ¢æˆSystem.currentTimeMillis()å—ï¼Ÿ</h3><p>ç­”ï¼šä¸å¯ä»¥</p>
<p><strong>SystemClock.uptimeMillis()</strong> è¿™ä¸ªæ–¹æ³•è·å–çš„æ—¶é—´ï¼Œæ˜¯è‡ªç³»ç»Ÿå¼€æœºåˆ°ç°åœ¨çš„ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ä¸ªç›¸å¯¹çš„</p>
<p><strong>System.currentTimeMillis()</strong> è¿™ä¸ªæ–¹æ³•è·å–çš„æ˜¯è‡ª<strong>1970-01-01 00:00:00</strong> åˆ°ç°åœ¨çš„ä¸€ä¸ªæ¯«ç§’æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªå’Œç³»ç»Ÿå¼ºå…³è”çš„æ—¶é—´ï¼Œè€Œä¸”è¿™ä¸ªå€¼å¯ä»¥åšä¿®æ”¹</p>
<p>1ã€ä½¿ç”¨System.currentTimeMillis()å¯èƒ½ä¼šå¯¼è‡´å»¶è¿Ÿæ¶ˆæ¯å¤±æ•ˆ</p>
<p>2ã€æœ€ç»ˆè¿™ä¸ªæ—¶é—´ä¼šè¢«è®¾ç½®åˆ°Messageçš„whenå±æ€§ï¼Œè€ŒMessageçš„whenå±æ€§åªæ˜¯éœ€è¦ä¸€ä¸ªæ—¶é—´å·®æ¥è¡¨ç¤ºæ¶ˆæ¯çš„å…ˆåé¡ºåºï¼Œä½¿ç”¨ä¸€ä¸ªç›¸å¯¹æ—¶é—´å°±è¡Œäº†ï¼Œæ²¡å¿…è¦ä½¿ç”¨ä¸€ä¸ªç»å¯¹æ—¶é—´</p>
<h3 id="7ã€ä¸ºä»€ä¹ˆLooperæ­»å¾ªç¯ï¼Œå´ä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ"><a href="#7ã€ä¸ºä»€ä¹ˆLooperæ­»å¾ªç¯ï¼Œå´ä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ" class="headerlink" title="7ã€ä¸ºä»€ä¹ˆLooperæ­»å¾ªç¯ï¼Œå´ä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ"></a>7ã€ä¸ºä»€ä¹ˆLooperæ­»å¾ªç¯ï¼Œå´ä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ</h3><p>ç­”ï¼šå› ä¸ºå½“Looperå¤„ç†å®Œæ‰€æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨Linuxçš„epollæœºåˆ¶è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œå½“æœ‰æ–°çš„Messageè¿›æ¥çš„æ—¶å€™ä¼šæ‰“ç ´é˜»å¡ç»§ç»­æ‰§è¡Œã€‚</p>
<p>åº”ç”¨å¡æ­»å³ANR: å…¨ç§°Applicationn Not Respondingï¼Œä¸­æ–‡æ„æ€æ˜¯åº”ç”¨æ— å“åº”ï¼Œå½“æˆ‘å‘é€ä¸€ä¸ªæ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ï¼ŒHandlerç»è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰æ‰§è¡Œå®Œè¿™æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä¼šæŠ›å‡ºANRå¼‚å¸¸</p>
<p>Looperæ­»å¾ªç¯: å¾ªç¯æ‰§è¡Œå„ç§äº‹åŠ¡ï¼ŒLooperæ­»å¾ªç¯è¯´æ˜çº¿ç¨‹è¿˜æ´»ç€ï¼Œå¦‚æœæ²¡æœ‰Looperæ­»å¾ªç¯ï¼Œçº¿ç¨‹ç»“æŸï¼Œåº”ç”¨å°±é€€å‡ºäº†ï¼Œå½“Looperå¤„ç†å®Œæ‰€æœ‰æ¶ˆæ¯çš„æ—¶å€™ä¼šè°ƒç”¨Linuxçš„epollæœºåˆ¶è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œå½“æœ‰æ–°çš„Messageè¿›æ¥çš„æ—¶å€™ä¼šæ‰“ç ´é˜»å¡ç»§ç»­æ‰§è¡Œ</p>
<h3 id="8ã€Handlerå†…å­˜æ³„éœ²åŸå› -å¦‚ä½•è§£å†³ï¼Ÿ"><a href="#8ã€Handlerå†…å­˜æ³„éœ²åŸå› -å¦‚ä½•è§£å†³ï¼Ÿ" class="headerlink" title="8ã€Handlerå†…å­˜æ³„éœ²åŸå› ? å¦‚ä½•è§£å†³ï¼Ÿ"></a>8ã€Handlerå†…å­˜æ³„éœ²åŸå› ? å¦‚ä½•è§£å†³ï¼Ÿ</h3><p>å†…å­˜æ³„æ¼çš„æœ¬è´¨æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„å¼•ç”¨ï¼Œå¯¼è‡´çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡æ— æ³•è¢«å›æ”¶ï¼Œä»è€Œå¯¼è‡´äº†å†…å­˜æ³„æ¼</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸ªå¯¼è‡´å†…å­˜æ³„æ¼çš„ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>           <span class="hljs-comment">//do something</span><br>        &#125;<br>    &#125;;<br>  <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-comment">//å‘é€ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯ï¼Œ10åˆ†é’Ÿååœ¨æ‰§è¡Œ</span><br>        mHandler.sendEmptyMessageDelayed(<span class="hljs-number">0x001</span>,<span class="hljs-number">10</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç :</p>
<p>1ã€æˆ‘ä»¬é€šè¿‡åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ªHandlerçš„å®ä¾‹</p>
<p>2ã€åœ¨<code>onCreate</code>æ–¹æ³•é‡Œé¢é€šè¿‡Handlerå®ä¾‹å‘é€äº†ä¸€ä¸ªå»¶è¿Ÿ10åˆ†é’Ÿæ‰§è¡Œçš„æ¶ˆæ¯</p>
<p>æˆ‘ä»¬å‘é€çš„è¿™ä¸ªå»¶è¿Ÿ10åˆ†é’Ÿæ‰§è¡Œçš„æ¶ˆæ¯å®ƒæ˜¯æŒæœ‰Handlerçš„å¼•ç”¨çš„ï¼Œæ ¹æ®Javaç‰¹æ€§æˆ‘ä»¬åˆçŸ¥é“ï¼Œéé™æ€å†…éƒ¨ç±»ä¼šæŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå› æ­¤å½“å‰HandleråˆæŒæœ‰Activityçš„å¼•ç”¨ï¼Œè€ŒMessageåˆå­˜åœ¨MessageQueueä¸­ï¼ŒMessageQueueåˆåœ¨å½“å‰çº¿ç¨‹ä¸­ï¼Œå› æ­¤ä¼šå­˜åœ¨ä¸€ä¸ªå¼•ç”¨é“¾å…³ç³»:</p>
<p><strong>å½“å‰çº¿ç¨‹-&gt;MessageQueue-&gt;Message-&gt;Handler-&gt;Activity</strong></p>
<p>å› æ­¤å½“æˆ‘ä»¬é€€å‡ºActivityçš„æ—¶å€™ï¼Œç”±äºæ¶ˆæ¯éœ€è¦åœ¨10åˆ†é’Ÿååœ¨æ‰§è¡Œï¼Œå› æ­¤ä¼šä¸€ç›´æŒæœ‰Activityï¼Œä»è€Œå¯¼è‡´äº†Activityçš„å†…å­˜æ³„æ¼</p>
<p>é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬çŸ¥é“äº†å†…å­˜æ³„æ¼çš„åŸå› å°±æ˜¯æŒæœ‰äº†Activityçš„å¼•ç”¨ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¼šæƒ³ï¼Œåˆ‡æ–­è¿™æ¡å¼•ç”¨ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬éœ€è¦ç”¨åˆ°Activityç›¸å…³çš„å±æ€§å’Œæ–¹æ³•é‡‡ç”¨å¼±å¼•ç”¨çš„æ–¹å¼ä¸å°±å¯ä»¥äº†ä¹ˆï¼Ÿæˆ‘ä»¬å®é™…æ“ä½œä¸€ä¸‹ï¼ŒæŠŠHandlerå†™æˆä¸€ä¸ªé™æ€å†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SafeHandler</span> <span class="hljs-variable">mSafeHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeHandler</span>(<span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>      	<span class="hljs-comment">//å‘é€ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯ï¼Œ10åˆ†é’Ÿååœ¨æ‰§è¡Œ</span><br>        mSafeHandler.sendEmptyMessageDelayed(<span class="hljs-number">0x001</span>,<span class="hljs-number">10</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//é™æ€å†…éƒ¨ç±»å¹¶æŒæœ‰Activityçš„å¼±å¼•ç”¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span>&#123;<br>      <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;MainActivity&gt; mWeakReference;<br>      <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeHandler</span><span class="hljs-params">(MainActivity activity)</span>&#123;<br>            mWeakReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(activity);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-type">MainActivity</span> <span class="hljs-variable">mMainActivity</span> <span class="hljs-operator">=</span> mWeakReference.get();<br>            <span class="hljs-keyword">if</span>(mMainActivity != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//do something</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç </p>
<p>1ã€æŠŠHandlerå®šä¹‰æˆäº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå¹¶æŒæœ‰å½“å‰Activityçš„å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨ä¼šåœ¨Javaè™šæ‹Ÿæœºå‘ç”Ÿgcçš„æ—¶å€™æŠŠå¯¹è±¡ç»™å›æ”¶æ‰</p>
<p>ç»è¿‡ä¸Šè¿°æ”¹é€ ï¼Œæˆ‘ä»¬è§£å†³äº†Activityçš„å†…å­˜æ³„æ¼ï¼Œæ­¤æ—¶çš„å¼•ç”¨é“¾å…³ç³»ä¸º:</p>
<p><strong>å½“å‰çº¿ç¨‹-&gt;MessageQueue-&gt;Message-&gt;Handler</strong></p>
<p>æˆ‘ä»¬ä¼šå‘ç°Messageè¿˜æ˜¯ä¼šæŒæœ‰Handlerçš„å¼•ç”¨ï¼Œä»è€Œå¯¼è‡´Handlerä¹Ÿä¼šå†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨Activityé”€æ¯çš„æ—¶å€™ï¼Œåœ¨ä»–çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•é‡Œï¼ŒæŠŠMessageQueueä¸­çš„Messageéƒ½ç»™ç§»é™¤æ‰ï¼Œå› æ­¤æœ€ç»ˆå°±å˜æˆäº†è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SafeHandler</span> <span class="hljs-variable">mSafeHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeHandler</span>(<span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>      	<span class="hljs-comment">//å‘é€ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯ï¼Œ10åˆ†é’Ÿååœ¨æ‰§è¡Œ</span><br>        mSafeHandler.sendEmptyMessageDelayed(<span class="hljs-number">0x001</span>,<span class="hljs-number">10</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>);<br>    &#125;<br>  <br>  	<span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.onDestroy();<br>        mSafeHandler.removeCallbacksAndMessages(<span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//é™æ€å†…éƒ¨ç±»å¹¶æŒæœ‰Activityçš„å¼±å¼•ç”¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span>&#123;<br>      <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;MainActivity&gt; mWeakReference;<br>      <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeHandler</span><span class="hljs-params">(MainActivity activity)</span>&#123;<br>            mWeakReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(activity);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;<br>            <span class="hljs-type">MainActivity</span> <span class="hljs-variable">mMainActivity</span> <span class="hljs-operator">=</span> mWeakReference.get();<br>            <span class="hljs-keyword">if</span>(mMainActivity != <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//do something</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤å½“Activityé”€æ¯åï¼Œå¼•ç”¨é“¾å…³ç³»ä¸º:</p>
<p><strong>å½“å‰çº¿ç¨‹-&gt;MessageQueue</strong></p>
<p>è€Œå½“å‰çº¿ç¨‹å’ŒMessageQueueçš„ç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·é•¿çš„ï¼Œå› æ­¤ä¹Ÿå°±ä¸å­˜åœ¨å†…å­˜æ³„æ¼äº†ï¼Œå®Œç¾ã€‚</p>
<p>æ‰€ä»¥è§£å†³Handlerå†…å­˜æ³„æ¼æœ€å¥½çš„æ–¹å¼å°±æ˜¯ï¼š<strong>å°†Handlerå®šä¹‰æˆé™æ€å†…éƒ¨ç±»ï¼Œå†…éƒ¨æŒæœ‰Activityçš„å¼±å¼•ç”¨ï¼Œå¹¶åœ¨Activityé”€æ¯çš„æ—¶å€™ç§»é™¤æ‰€æœ‰æ¶ˆæ¯</strong></p>
<h3 id="9ã€çº¿ç¨‹ç»´æŠ¤çš„Looperï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#9ã€çº¿ç¨‹ç»´æŠ¤çš„Looperï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="9ã€çº¿ç¨‹ç»´æŠ¤çš„Looperï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>9ã€çº¿ç¨‹ç»´æŠ¤çš„Looperï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶çš„å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h3><p>ç­”ï¼šå½“æ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯æ—¶ï¼ŒLooperä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œé‡Šæ”¾cpuèµ„æºï¼Œæé«˜Appæ€§èƒ½</p>
<p>æˆ‘ä»¬çŸ¥é“Looperçš„<code>loop</code>æ–¹æ³•ä¸­æœ‰ä¸ªæ­»å¾ªç¯ä¸€ç›´åœ¨è¯»å–MessageQueueä¸­çš„æ¶ˆæ¯ï¼Œå…¶å®æ˜¯è°ƒç”¨äº†MessageQueueä¸­çš„<code>next</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨æ— æ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨Linuxçš„epollæœºåˆ¶ï¼Œä½¿å¾—çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå½“æœ‰æ–°æ¶ˆæ¯åˆ°æ¥æ—¶ï¼Œå°±ä¼šå°†å®ƒå”¤é†’ï¼Œnextæ–¹æ³•é‡Œä¼šåˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦æ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™é˜»å¡çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¼šè¿”å›è¿™æ¡æ¶ˆæ¯å¹¶å°†å…¶ä»ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­ç»™ç§»é™¤</p>
<h3 id="10ã€MessageQueueä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«å”¤é†’ï¼Ÿ"><a href="#10ã€MessageQueueä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«å”¤é†’ï¼Ÿ" class="headerlink" title="10ã€MessageQueueä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«å”¤é†’ï¼Ÿ"></a>10ã€MessageQueueä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«å”¤é†’ï¼Ÿ</h3><p>ç­”ï¼šéœ€è¦åˆ†æƒ…å†µ</p>
<p>1ã€å‘é€æ¶ˆæ¯è¿‡æ¥ï¼Œæ­¤æ—¶MessageQueueä¸­æ— æ¶ˆæ¯æˆ–è€…å½“å‰å‘é€è¿‡æ¥çš„æ¶ˆæ¯æºå¸¦çš„whenä¸º0æˆ–è€…æœ‰å»¶è¿Ÿæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆéœ€è¦å”¤é†’</p>
<p>2ã€å½“é‡åˆ°åŒæ­¥å±éšœä¸”å½“å‰å‘é€è¿‡æ¥çš„æ¶ˆæ¯ä¸ºå¼‚æ­¥æ¶ˆæ¯ï¼Œåˆ¤æ–­è¯¥å¼‚æ­¥æ¶ˆæ¯æ˜¯å¦æ’å…¥åœ¨æ‰€æœ‰å¼‚æ­¥æ¶ˆæ¯çš„é˜Ÿé¦–ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦å”¤é†’ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸å”¤é†’</p>
<h3 id="11ã€çº¿ç¨‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«é˜»å¡ï¼Ÿ"><a href="#11ã€çº¿ç¨‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«é˜»å¡ï¼Ÿ" class="headerlink" title="11ã€çº¿ç¨‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«é˜»å¡ï¼Ÿ"></a>11ã€çº¿ç¨‹ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«é˜»å¡ï¼Ÿ</h3><p>ç­”ï¼šåˆ†æƒ…å†µ</p>
<p>1ã€å½“MessageQueueä¸­æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæ— é™é˜»å¡ï¼Œ</p>
<p>2ã€å½“å‰MessageQueueä¸­å…¨éƒ¨æ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œé˜»å¡æ—¶é—´ä¸º(å½“å‰å»¶è¿Ÿæ¶ˆæ¯æ—¶é—´ - å½“å‰æ—¶é—´)ï¼Œå¦‚æœè¿™ä¸ªé˜»å¡æ—¶é—´è¶…è¿‡æ¥Integerç±»å‹çš„æœ€å¤§å€¼ï¼Œåˆ™å–Integerç±»å‹çš„æœ€å¤§å€¼</p>
<h3 id="12ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªHandlerå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å‘æ¶ˆæ¯çš„Handlerå­˜åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆHandleræ˜¯å¦‚ä½•ä¿è¯MessageQueueå¹¶å‘è®¿é—®å®‰å…¨çš„å‘¢ï¼Ÿ"><a href="#12ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªHandlerå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å‘æ¶ˆæ¯çš„Handlerå­˜åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆHandleræ˜¯å¦‚ä½•ä¿è¯MessageQueueå¹¶å‘è®¿é—®å®‰å…¨çš„å‘¢ï¼Ÿ" class="headerlink" title="12ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªHandlerå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å‘æ¶ˆæ¯çš„Handlerå­˜åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆHandleræ˜¯å¦‚ä½•ä¿è¯MessageQueueå¹¶å‘è®¿é—®å®‰å…¨çš„å‘¢ï¼Ÿ"></a>12ã€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªHandlerå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆå¯èƒ½å­˜åœ¨å‘æ¶ˆæ¯çš„Handlerå­˜åœ¨ä¸åŒçš„çº¿ç¨‹ï¼Œé‚£ä¹ˆHandleræ˜¯å¦‚ä½•ä¿è¯MessageQueueå¹¶å‘è®¿é—®å®‰å…¨çš„å‘¢ï¼Ÿ</h3><p>ç­”ï¼šå¾ªç¯åŠ é”ï¼Œé…åˆé˜»å¡å”¤é†’æœºåˆ¶</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°MessageQueueå…¶å®æ˜¯â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å‹ï¼ŒHandlerä¸æ–­åœ°æ”¾å…¥æ¶ˆæ¯ï¼ŒLooperä¸æ–­åœ°å–å‡ºï¼Œè¿™å°±æ¶‰åŠåˆ°æ­»é”é—®é¢˜ã€‚å¦‚æœLooperæ‹¿åˆ°é”ï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œè€ŒHandleréœ€è¦æŠŠæ¶ˆæ¯æ”¾è¿›å»ï¼Œé”å´è¢«Looperæ‹¿ç€æ— æ³•å…¥é˜Ÿï¼Œè¿™å°±é€ æˆäº†æ­»é”ã€‚Handleræœºåˆ¶çš„è§£å†³æ–¹æ³•æ˜¯<strong>å¾ªç¯åŠ é”</strong>ã€‚åœ¨MessageQueueçš„nextæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>   ...<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>  ...<br>        nativePollOnce(ptr, nextPollTimeoutMillis);<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            ...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»–çš„ç­‰å¾…æ˜¯åœ¨é”å¤–çš„ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼Œä»–ä¼šå…ˆé‡Šæ”¾é”ï¼Œå†è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚è¿™æ ·å°±ä¸ä¼šé€ æˆæ­»é”é—®é¢˜äº†ã€‚</p>
<p>é‚£åœ¨å…¥é˜Ÿçš„æ—¶å€™ä¼šä¸ä¼šå› ä¸ºé˜Ÿåˆ—å·²ç»æ»¡äº†ç„¶åä¸€è¾¹åœ¨ç­‰å¾…æ¶ˆæ¯å¤„ç†ä¸€è¾¹æ‹¿ç€é”å‘¢ï¼Ÿè¿™ä¸€ç‚¹ä¸åŒçš„æ˜¯MessageQueueçš„æ¶ˆæ¯æ²¡æœ‰ä¸Šé™ï¼Œæˆ–è€…è¯´ä»–çš„ä¸Šé™å°±æ˜¯JVMç»™ç¨‹åºåˆ†é…çš„å†…å­˜ï¼Œå¦‚æœè¶…å‡ºå†…å­˜ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šçš„ã€‚</p>
<h3 id="13ã€Handleræ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ"><a href="#13ã€Handleræ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ" class="headerlink" title="13ã€Handleræ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ"></a>13ã€Handleræ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ</h3><p>ç­”ï¼šä½¿ç”¨ä¸åŒçº¿ç¨‹çš„Looperå¤„ç†æ¶ˆæ¯</p>
<p>æˆ‘ä»¬é€šå¸¸å¤„ç†æ¶ˆæ¯æ˜¯åœ¨Handlerçš„<code>handleMessage</code>æ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å“ªé‡Œå›è°ƒçš„å‘¢ï¼Ÿçœ‹ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//å¼€å¯æ­»å¾ªç¯è¯»å–æ¶ˆæ¯</span><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>         <span class="hljs-comment">// è°ƒç”¨Messageå¯¹åº”çš„Handlerå¤„ç†æ¶ˆæ¯</span><br>         msg.target.dispatchMessage(msg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ä¸­<code>msg.target</code>å…¶å®å°±æ˜¯æˆ‘ä»¬å‘é€æ¶ˆæ¯çš„Handlerï¼Œå› æ­¤ä»–ä¼šå›è°ƒHandlerçš„<code>dispatchMessage</code>æ–¹æ³•ï¼Œè€Œ<code>dispatchMessage</code>è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡ä¸­é‡ç‚¹åˆ†æè¿‡ï¼Œå…¶ä¸­æœ‰ä¸€éƒ¨åˆ†é€»è¾‘å°±æ˜¯ä¼šå›è°ƒåˆ°Handlerçš„<code>handleMessage</code>æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å‘ç°ï¼ŒHandlerçš„<code>handleMessage</code>æ–¹æ³•æ‰€åœ¨çš„çº¿ç¨‹æ˜¯ç”±Looperçš„<code>loop</code>æ–¹æ³•å†³å®šçš„ã€‚å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™ï¼Œæ˜¯ä»å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ° Handlerï¼Œè€Œè¿™ä¸ª Handler çš„ <code>handleMessage()</code> æ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨çš„ï¼Œå› ä¸ºLooperæ˜¯åœ¨ä¸»çº¿ç¨‹åˆ›å»ºçš„ï¼Œæ‰€ä»¥æ¶ˆæ¯å°±ä»å¼‚æ­¥çº¿ç¨‹åˆ‡æ¢åˆ°äº†ä¸»çº¿ç¨‹ã€‚</p>
<h3 id="14ã€æˆ‘ä»¬åœ¨ä½¿ç”¨Messageçš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•å»åˆ›å»ºå®ƒï¼Ÿ"><a href="#14ã€æˆ‘ä»¬åœ¨ä½¿ç”¨Messageçš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•å»åˆ›å»ºå®ƒï¼Ÿ" class="headerlink" title="14ã€æˆ‘ä»¬åœ¨ä½¿ç”¨Messageçš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•å»åˆ›å»ºå®ƒï¼Ÿ"></a>14ã€æˆ‘ä»¬åœ¨ä½¿ç”¨Messageçš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•å»åˆ›å»ºå®ƒï¼Ÿ</h3><p>ç­”ï¼šAndroid ç»™ Message è®¾è®¡äº†å›æ”¶æœºåˆ¶ï¼Œå®˜æ–¹å»ºè®®æ˜¯é€šè¿‡<code>Message.obtain</code>æ–¹æ³•æ¥è·å–ï¼Œè€Œä¸æ˜¯ç›´æ¥newä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™åº”å°½é‡å¤ç”¨ Message ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ï¼Œæ–¹å¼æœ‰äºŒï¼š</p>
<p>1ã€è°ƒç”¨ Message çš„ä¸€ç³»åˆ—é™æ€é‡è½½æ–¹æ³• <code>Message.obtain</code>  è·å–</p>
<p>2ã€é€šè¿‡ Handler çš„å…¬æœ‰æ–¹æ³• <code>handler.obtainMessage</code>ï¼Œå®é™…ä¸Š<code>handler.obtainMessage</code>å†…éƒ¨è°ƒç”¨çš„ä¹Ÿæ˜¯<code>Message.obtain</code>çš„é‡è½½æ–¹æ³•</p>
<h3 id="15ã€Handleré‡Œé¢è—ç€çš„CallBackèƒ½åšä»€ä¹ˆï¼Ÿ"><a href="#15ã€Handleré‡Œé¢è—ç€çš„CallBackèƒ½åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="15ã€Handleré‡Œé¢è—ç€çš„CallBackèƒ½åšä»€ä¹ˆï¼Ÿ"></a>15ã€Handleré‡Œé¢è—ç€çš„CallBackèƒ½åšä»€ä¹ˆï¼Ÿ</h3><p>ç­”: åˆ©ç”¨æ­¤CallBackæ‹¦æˆªHandlerçš„æ¶ˆæ¯å¤„ç†</p>
<p>åœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬åˆ†æåˆ°ï¼Œ<code>dispatchMessage</code>æ–¹æ³•çš„å¤„ç†æ­¥éª¤:</p>
<p>1ã€é¦–å…ˆï¼Œæ£€æŸ¥Messageçš„callbackæ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullå°±é€šè¿‡<code>handleCallBack</code>æ¥å¤„ç†æ¶ˆæ¯ï¼ŒMessageçš„callbackæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯Handlerçš„<code>post</code>ç³»åˆ—æ–¹æ³•æ‰€ä¼ é€’çš„Runnableå‚æ•°</p>
<p>2ã€å…¶æ¬¡ï¼Œæ£€æŸ¥Handleré‡Œé¢è—ç€çš„CallBackæ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullå°±è°ƒç”¨mCallbackçš„<code>handleMessage</code>æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ï¼Œå¹¶åˆ¤æ–­å…¶è¿”å›å€¼ï¼šä¸ºtrueï¼Œé‚£ä¹ˆ Handler çš„ <code>handleMessage(msg)</code> æ–¹æ³•å°±ä¸ä¼šè¢«è°ƒç”¨äº†ï¼›ä¸ºfalseï¼Œé‚£ä¹ˆå°±æ„å‘³ç€<strong>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥åŒæ—¶è¢« Callback ä»¥åŠ Handler å¤„ç†</strong>ã€‚</p>
<p>3ã€æœ€åï¼Œè°ƒç”¨Handlerçš„<code>handleMessage</code>æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯</p>
<p>é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬çŸ¥é“Handlerå¤„ç†æ¶ˆæ¯çš„é¡ºåºæ˜¯ï¼š<strong>Messageçš„Callback &gt; Handlerçš„Callback &gt; Handlerçš„<code>handleMessage</code>æ–¹æ³•</strong></p>
<p>ä½¿ç”¨åœºæ™¯: Hook ActivityThread.mH ï¼Œ åœ¨ ActivityThread ä¸­æœ‰ä¸ªæˆå‘˜å˜é‡ <code>mH</code> ï¼Œå®ƒæ˜¯ä¸ª Handlerï¼Œåˆæ˜¯ä¸ªæå…¶é‡è¦çš„ç±»ï¼Œå‡ ä¹æ‰€æœ‰çš„æ’ä»¶åŒ–æ¡†æ¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚</p>
<h3 id="16ã€Handleré˜»å¡å”¤é†’æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ"><a href="#16ã€Handleré˜»å¡å”¤é†’æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ" class="headerlink" title="16ã€Handleré˜»å¡å”¤é†’æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ"></a>16ã€Handleré˜»å¡å”¤é†’æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿ</h3><p>ç­”ï¼š Handlerçš„é˜»å¡å”¤é†’æœºåˆ¶æ˜¯åŸºäºLinuxçš„é˜»å¡å”¤é†’æœºåˆ¶ã€‚</p>
<p>è¿™ä¸ªæœºåˆ¶ä¹Ÿæ˜¯ç±»ä¼¼äºhandleræœºåˆ¶çš„æ¨¡å¼ã€‚åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åéœ€è¦ç­‰å¾…çš„ä¸€æ–¹åˆ™ç›‘å¬è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå”¤é†’çš„ä¸€æ–¹åªéœ€è¦ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆç­‰å¾…çš„ä¸€æ–¹å°±ä¼šæ”¶åˆ°æ–‡ä»¶ä»è€Œæ‰“ç ´å”¤é†’ã€‚å’ŒLooperç›‘å¬MessageQueueï¼ŒHandleræ·»åŠ messageæ˜¯æ¯”è¾ƒç±»ä¼¼çš„ã€‚å…·ä½“çš„Linuxå±‚çŸ¥è¯†è¯»è€…å¯é€šè¿‡è¿™ç¯‡æ–‡ç« è¯¦ç»†äº†è§£ï¼ˆ<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Ylc5mPwMzWoK2CIthZy0Vw">ä¼ é€é—¨</a>ï¼‰</p>
<h3 id="17ã€ä»€ä¹ˆæ˜¯Handlerçš„åŒæ­¥å±éšœï¼Ÿ"><a href="#17ã€ä»€ä¹ˆæ˜¯Handlerçš„åŒæ­¥å±éšœï¼Ÿ" class="headerlink" title="17ã€ä»€ä¹ˆæ˜¯Handlerçš„åŒæ­¥å±éšœï¼Ÿ"></a>17ã€ä»€ä¹ˆæ˜¯Handlerçš„åŒæ­¥å±éšœï¼Ÿ</h3><p>ç­”: åŒæ­¥å±éšœæ˜¯ä¸€ç§ä½¿å¾—å¼‚æ­¥æ¶ˆæ¯å¯ä»¥è¢«æ›´å¿«å¤„ç†çš„æœºåˆ¶</p>
<h3 id="18ã€èƒ½ä¸èƒ½è®©ä¸€ä¸ªMessageè¢«åŠ æ€¥å¤„ç†ï¼Ÿ"><a href="#18ã€èƒ½ä¸èƒ½è®©ä¸€ä¸ªMessageè¢«åŠ æ€¥å¤„ç†ï¼Ÿ" class="headerlink" title="18ã€èƒ½ä¸èƒ½è®©ä¸€ä¸ªMessageè¢«åŠ æ€¥å¤„ç†ï¼Ÿ"></a>18ã€èƒ½ä¸èƒ½è®©ä¸€ä¸ªMessageè¢«åŠ æ€¥å¤„ç†ï¼Ÿ</h3><p>ç­”ï¼šå¯ä»¥ï¼Œæ·»åŠ åŠ åŒæ­¥å±éšœï¼Œå¹¶å‘é€å¼‚æ­¥æ¶ˆæ¯</p>
<h3 id="19ã€ä»€ä¹ˆæ˜¯IdleHandlerï¼Ÿ"><a href="#19ã€ä»€ä¹ˆæ˜¯IdleHandlerï¼Ÿ" class="headerlink" title="19ã€ä»€ä¹ˆæ˜¯IdleHandlerï¼Ÿ"></a>19ã€ä»€ä¹ˆæ˜¯IdleHandlerï¼Ÿ</h3><p>ç­”: IdleHandleræ˜¯MessageQueueä¸­ä¸€ä¸ªé™æ€å‡½æ•°å‹æ¥å£ï¼Œå®ƒåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ‰€æœ‰çš„Viewäº‹åŠ¡åï¼Œå›è°ƒä¸€äº›é¢å¤–çš„æ“ä½œï¼Œä¸”ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Handleræ¶ˆæ¯æœºåˆ¶åœ¨Androidç³»ç»Ÿæºç ä¸­è¿›è¡Œäº†å¤§é‡çš„ä½¿ç”¨ï¼Œå¯ä»¥è¯´æ˜¯æ¶‰åŠäº†Androidçš„æ–¹æ–¹é¢é¢ï¼Œæ¯”å¦‚æˆ‘ä»¬å››å¤§ç»„ä»¶çš„å¯åŠ¨ï¼ŒApplicationçš„åˆ›å»ºç­‰ç­‰ï¼Œå­¦å¥½Handlerç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å»é˜…è¯»Androidæºç ï¼Œè€Œä¸”Handleråœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ç›´æ¥æˆ–é—´æ¥çš„ä¼šè¢«ç”¨åˆ°ã€‚åŒæ—¶é€šè¿‡å¯¹Handleræºç çš„å­¦ä¹ ï¼Œè®©æˆ‘æ„Ÿå—åˆ°äº†ä»£ç è®¾è®¡çš„èƒŒåï¼Œè•´è—ç€å·¥ç¨‹å¸ˆå¤§é‡çš„æ™ºæ…§ï¼Œå¿ƒé‡Œç›´å‘¼666ï¼Œå“ˆå“ˆã€‚</p>
<p>åˆ°äº†è¿™é‡Œï¼Œå…³äºHandlerç›¸å…³çš„çŸ¥è¯†å°±éƒ½è®²å®Œäº†ï¼Œå¦‚æœä½ è¿˜æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œè¯„è®ºåŒºå‘Šè¯‰æˆ‘å§ã€‚</p>
<h2 id="å‚è€ƒå’Œæ¨è"><a href="#å‚è€ƒå’Œæ¨è" class="headerlink" title="å‚è€ƒå’Œæ¨è"></a>å‚è€ƒå’Œæ¨è</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6887933281686421518">Androidå…¨é¢è§£æä¹‹Handleræœºåˆ¶ï¼ˆç»ˆç¯‡ï¼‰ï¼šå¸¸è§é—®é¢˜æ±‡æ€»</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903783139393550">Handler éƒ½æ²¡ææ‡‚ï¼Œæ‹¿ä»€ä¹ˆå»è·³æ§½å•Šï¼Ÿ</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904150140977165#heading-22">æ¢ä¸ªå§¿åŠ¿ï¼Œå¸¦ç€é—®é¢˜çœ‹Handler</a></p>
<blockquote>
<p>å…¨æ–‡åˆ°æ­¤ï¼ŒåŸåˆ›ä¸æ˜“ï¼Œæ¬¢è¿ç‚¹èµï¼Œæ”¶è—ï¼Œè¯„è®ºå’Œè½¬å‘ï¼Œä½ çš„è®¤å¯æ˜¯æˆ‘åˆ›ä½œçš„åŠ¨åŠ›</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Android/" class="category-chain-item">Android</a>
  
  
    <span>></span>
    
  <a href="/categories/Android/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F/" class="category-chain-item">ä¸€ç¯‡å°±å¤Ÿ</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8E%9F%E5%88%9B/">#åŸåˆ›</a>
      
        <a href="/tags/Android/">#Android</a>
      
        <a href="/tags/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F/">#ä¸€ç¯‡å°±å¤Ÿ</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡</div>
      <div>https://sweetying520.github.io/2022/10/11/ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ‰©å±•ç¯‡/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>sweetying</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´10æœˆ11æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9AAndroid%20Emoji%20%E8%A1%A8%E6%83%85%E5%88%86%E4%BA%AB%E5%92%8C%E5%AE%9E%E8%B7%B5/" title="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šAndroid Emoji è¡¨æƒ…åˆ†äº«å’Œå®è·µ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šAndroid Emoji è¡¨æƒ…åˆ†äº«å’Œå®è·µ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/11/%E4%B8%80%E7%AF%87%E5%B0%B1%E5%A4%9F%E7%B3%BB%E5%88%97%EF%BC%9AHandler%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/" title="ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ">
                        <span class="hidden-mobile">ä¸€ç¯‡å°±å¤Ÿç³»åˆ—ï¼šHandleræ¶ˆæ¯æœºåˆ¶å®Œå…¨è§£æ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"zN1E017kYhKuj6GqXHJSbGMb-gzGzoHsz","appKey":"JSwY8PjtA131Y78OHn7kKtio","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
